<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Financial Modeling Platform - Module 1 Complete</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .module-card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.07); 
            transition: all 0.3s; 
        }
        .module-card:hover { 
            box-shadow: 0 10px 20px rgba(0,0,0,0.12); 
            transform: translateY(-2px); 
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        input[type="number"], input[type="text"], input[type="date"], select { 
            transition: all 0.2s; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            transition: all 0.3s; 
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); 
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.875rem;
        }
        th {
            position: sticky;
            top: 0;
            background: #1f2937;
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #374151;
        }
        td {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: right;
        }
        td:first-child {
            text-align: left;
            font-weight: 500;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }
        .total-row {
            background: #e0e7ff;
            font-weight: 700;
        }
        .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Yellow input styling for assumptions */
        .input-assumption {
            background-color: #fef3c7 !important;
            color: #1e40af !important;
            font-weight: 600;
            border: 1px solid #fbbf24 !important;
        }
        .editable-label {
            background-color: #fef3c7;
            color: #1e40af;
            font-weight: 600;
            border: 1px solid #fbbf24;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Development Costs specific styles */
        .cost-input-table td {
            text-align: left;
            padding: 0.5rem;
        }
        .cost-input-table input, .cost-input-table select {
            width: 100%;
            padding: 0.375rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .validation-error {
            color: #dc2626;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .total-row td:first-child {
            background: #dbeafe;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function RealEstatePlatform() {
            // State Management
            const [activeModule, setActiveModule] = useState('overview');
            const [activeTab, setActiveTab] = useState('timeline');
            
            // Timeline
            const [projectName, setProjectName] = useState('Skyline');
            const [projectType, setProjectType] = useState('mixed-use');
            const [country, setCountry] = useState('United States');
            const [currency, setCurrency] = useState('USD');
            const [modelType, setModelType] = useState('monthly');
            const [projectStart, setProjectStart] = useState('2025-01-01');
            const [constructionPeriods, setConstructionPeriods] = useState(24);
            const [operationsPeriods, setOperationsPeriods] = useState(60);
            
            // Handle model type change with auto-conversion
            const handleModelTypeChange = (newType) => {
                const toAnnual = (newType === 'annual');
                const convP = (p) => toAnnual ? Math.round(p / 12) : p * 12;
                const convPhasing = (phasing) => {
                    if (!phasing) return phasing;
                    // Handle object phasing
                    if (typeof phasing === 'object') {
                        if (phasing.type === 'even') return phasing;
                        const parts = phasing.values || [];
                        if (toAnnual) {
                            const result = [];
                            for (let i=0; i<parts.length; i+=12) result.push(parseFloat(parts.slice(i,i+12).reduce((a,b)=>a+b,0).toFixed(1)));
                            return { type:'manual', values: result };
                        } else {
                            const result = [];
                            parts.forEach(n => { for(let m=0;m<12;m++) result.push(parseFloat((n/12).toFixed(2))); });
                            return { type:'manual', values: result };
                        }
                    }
                    if (phasing.trim().toLowerCase() === 'even') return phasing;
                    const parts = phasing.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                    if (toAnnual) {
                        const result = [];
                        for (let i=0; i<parts.length; i+=12) result.push(parseFloat(parts.slice(i,i+12).reduce((a,b)=>a+b,0).toFixed(1)));
                        return { type:'manual', values: result };
                    } else {
                        const result = [];
                        parts.forEach(n => { for(let m=0;m<12;m++) result.push(parseFloat((n/12).toFixed(2))); });
                        return { type:'manual', values: result };
                    }
                };
                const convertCosts = (prev) => prev.map(c => ({
                    ...c,
                    startPeriod: convP(c.startPeriod),
                    endPeriod:   convP(c.endPeriod),
                    phasing:     convPhasing(c.phasing)
                }));
                if (modelType === 'monthly' && newType === 'annual') {
                    setConstructionPeriods(Math.round(constructionPeriods / 12));
                    setOperationsPeriods(Math.round(operationsPeriods / 12));
                } else if (modelType === 'annual' && newType === 'monthly') {
                    setConstructionPeriods(constructionPeriods * 12);
                    setOperationsPeriods(operationsPeriods * 12);
                }
                setResidentialCosts(convertCosts);
                setHospitalityCosts(convertCosts);
                setRetailCosts(convertCosts);
                setModelType(newType);
            };
            
            // Land & Area
            const [cashPercent, setCashPercent] = useState(60);
            const [inKindPercent, setInKindPercent] = useState(40);
            const [totalLandArea, setTotalLandArea] = useState(100000);
            const [landValuePerSqm, setLandValuePerSqm] = useState(500);
            
            const [residentialPercent, setResidentialPercent] = useState(50);
            const [hospitalityPercent, setHospitalityPercent] = useState(30);
            const [retailPercent, setRetailPercent] = useState(20);
            
            const [residentialRoadsPercent, setResidentialRoadsPercent] = useState(20);
            const [hospitalityRoadsPercent, setHospitalityRoadsPercent] = useState(15);
            const [retailRoadsPercent, setRetailRoadsPercent] = useState(10);
            
            const [residentialFAR, setResidentialFAR] = useState(1.5);
            const [residentialEfficiency, setResidentialEfficiency] = useState(0.85);
            const [residentialGFABase, setResidentialGFABase] = useState('netDevelopable');
            const [residentialBUABase, setResidentialBUABase] = useState('gfa');
            const [residentialCustomRows, setResidentialCustomRows] = useState([]);
            
            const [hospitalityFAR, setHospitalityFAR] = useState(1.2);
            const [hospitalityEfficiency, setHospitalityEfficiency] = useState(0.80);
            const [hospitalityGFABase, setHospitalityGFABase] = useState('netDevelopable');
            const [hospitalityBUABase, setHospitalityBUABase] = useState('gfa');
            const [hospitalityCustomRows, setHospitalityCustomRows] = useState([]);
            
            const [retailFAR, setRetailFAR] = useState(1.0);
            const [retailEfficiency, setRetailEfficiency] = useState(0.90);
            const [retailGFABase, setRetailGFABase] = useState('netDevelopable');
            const [retailBUABase, setRetailBUABase] = useState('gfa');
            const [retailCustomRows, setRetailCustomRows] = useState([]);
            
            // Custom area metrics for each asset (editable/addable/deletable)
            const [residentialMetrics, setResidentialMetrics] = useState([
                { id: 1, name: 'Net Developable Area', type: 'calculated', formula: 'totalArea - roadsArea', isLocked: true },
                { id: 2, name: 'FAR', type: 'input', value: 1.5, isLocked: false },
                { id: 3, name: 'GFA', type: 'calculated', formula: 'netArea × FAR', isLocked: false, baseArea: 'netDevelopable' },
                { id: 4, name: 'Efficiency %', type: 'input', value: 85, isLocked: false },
                { id: 5, name: 'BUA', type: 'calculated', formula: 'GFA × Efficiency%', isLocked: false, baseArea: 'gfa' }
            ]);
            const [hospitalityMetrics, setHospitalityMetrics] = useState([
                { id: 1, name: 'Net Developable Area', type: 'calculated', formula: 'totalArea - roadsArea', isLocked: true },
                { id: 2, name: 'FAR', type: 'input', value: 1.2, isLocked: false },
                { id: 3, name: 'GFA', type: 'calculated', formula: 'netArea × FAR', isLocked: false, baseArea: 'netDevelopable' },
                { id: 4, name: 'Efficiency %', type: 'input', value: 80, isLocked: false },
                { id: 5, name: 'BUA', type: 'calculated', formula: 'GFA × Efficiency%', isLocked: false, baseArea: 'gfa' }
            ]);
            const [retailMetrics, setRetailMetrics] = useState([
                { id: 1, name: 'Net Developable Area', type: 'calculated', formula: 'totalArea - roadsArea', isLocked: true },
                { id: 2, name: 'FAR', type: 'input', value: 1.0, isLocked: false },
                { id: 3, name: 'GFA', type: 'calculated', formula: 'netArea × FAR', isLocked: false, baseArea: 'netDevelopable' },
                { id: 4, name: 'Efficiency %', type: 'input', value: 90, isLocked: false },
                { id: 5, name: 'BUA', type: 'calculated', formula: 'GFA × Efficiency%', isLocked: false, baseArea: 'gfa' }
            ]);
            
            // Functions to manage dynamic rows
            const addMetricRow = (assetType, setMetrics, metrics) => {
                const newId = Math.max(...metrics.map(m => m.id)) + 1;
                const newMetric = {
                    id: newId,
                    name: 'Custom Metric',
                    type: 'input',
                    value: 0,
                    isLocked: false,
                    baseArea: 'netDevelopable'
                };
                setMetrics([...metrics, newMetric]);
            };
            
            const deleteMetricRow = (metricId, setMetrics, metrics) => {
                setMetrics(metrics.filter(m => m.id !== metricId));
            };
            
            const updateMetricBaseArea = (metricId, newBaseArea, setMetrics, metrics) => {
                setMetrics(metrics.map(m => 
                    m.id === metricId ? { ...m, baseArea: newBaseArea } : m
                ));
            };
            
            // Financing
            const [interestRate, setInterestRate] = useState(7.5);
            
            // ============ DEVELOPMENT COSTS STATE ============
            const [residentialCosts, setResidentialCosts] = useState([]);
            const [hospitalityCosts, setHospitalityCosts] = useState([]);
            const [retailCosts, setRetailCosts] = useState([]);
            const [nextCostId, setNextCostId] = useState(13);

            // Initialize default residential costs
            useEffect(() => {
                if (residentialCosts.length === 0) {
                    const cashLandArea = (totalLandArea * cashPercent) / 100;
                    const residentialLandValue = cashLandArea * landValuePerSqm * (residentialPercent / 100);

                    setResidentialCosts([
                        {
                            id: 1,
                            name: 'Land (Cash Portion)',
                            method: 'fixed',
                            value: residentialLandValue,
                            baseType: '',
                            startPeriod: 0,
                            endPeriod: 0,
                            phasing: '100',
                            canDelete: false
                        },
                        {
                            id: 2,
                            name: 'Construction Cost',
                            method: 'rate_bua',
                            value: 1200,
                            baseType: '',
                            startPeriod: 7,
                            endPeriod: constructionPeriods,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 3,
                            name: 'Infrastructure Cost',
                            method: 'rate_total_area',
                            value: 150,
                            baseType: '',
                            startPeriod: 1,
                            endPeriod: 6,
                            phasing: '30,25,20,15,7,3',
                            canDelete: true
                        },
                        {
                            id: 4,
                            name: 'Landscaping Cost',
                            method: 'rate_total_area',
                            value: 50,
                            baseType: '',
                            startPeriod: 1,
                            endPeriod: 6,
                            phasing: '30,25,20,15,7,3',
                            canDelete: true
                        },
                        {
                            id: 5,
                            name: 'Pre-Operating Expenses',
                            method: 'percent_base',
                            value: 2,
                            baseType: 'infra_construction',
                            startPeriod: 1,
                            endPeriod: constructionPeriods,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 6,
                            name: 'Professional Fee',
                            method: 'percent_base',
                            value: 5,
                            baseType: 'infra_construction',
                            startPeriod: 1,
                            endPeriod: constructionPeriods,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 7,
                            name: 'Contingency Cost',
                            method: 'percent_base',
                            value: 3,
                            baseType: 'infra_construction',
                            startPeriod: 1,
                            endPeriod: constructionPeriods,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 8,
                            name: 'Developer Fee / Performance Fee',
                            method: 'percent_base',
                            value: 10,
                            baseType: 'infra_construction',
                            startPeriod: 1,
                            endPeriod: constructionPeriods,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 9,
                            name: 'Electricity Station',
                            method: 'fixed',
                            value: 500000,
                            baseType: '',
                            startPeriod: 3,
                            endPeriod: 8,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 10,
                            name: 'Bridges',
                            method: 'fixed',
                            value: 750000,
                            baseType: '',
                            startPeriod: 2,
                            endPeriod: 6,
                            phasing: 'even',
                            canDelete: true
                        },
                        {
                            id: 11,
                            name: 'Royal Commission Premium',
                            method: 'percent_base',
                            value: 2.5,
                            baseType: 'land_cost',
                            startPeriod: 0,
                            endPeriod: 0,
                            phasing: '100',
                            canDelete: true
                        },
                        {
                            id: 12,
                            name: 'RETT',
                            method: 'percent_base',
                            value: 5,
                            baseType: 'land_cost',
                            startPeriod: 0,
                            endPeriod: 0,
                            phasing: '100',
                            canDelete: true
                        }
                    ]);
                }
            }, []);

            // Update Land cost when dependencies change
            useEffect(() => {
                if (residentialCosts.length > 0) {
                    const cashLandArea = (totalLandArea * cashPercent) / 100;
                    const residentialLandValue = cashLandArea * landValuePerSqm * (residentialPercent / 100);

                    setResidentialCosts(prev => prev.map(cost => 
                        cost.id === 1 ? { ...cost, value: residentialLandValue } : cost
                    ));
                }
            }, [totalLandArea, landValuePerSqm, cashPercent, residentialPercent]);
            
            // Calculations
            const totalLandValue = totalLandArea * landValuePerSqm;
            const cashValue = (totalLandValue * cashPercent) / 100;
            const inKindValue = (totalLandValue * inKindPercent) / 100;
            
            // Project end date calculation
            const calculateProjectEndDate = () => {
                const startDate = new Date(projectStart);
                const totalMonths = modelType === 'monthly' 
                    ? constructionPeriods + operationsPeriods 
                    : (constructionPeriods + operationsPeriods) * 12;
                
                // Add months and subtract 1 day to get end of last month
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + totalMonths);
                endDate.setDate(0); // Last day of previous month
                
                return endDate.toISOString().split('T')[0];
            };
            
            const projectEndDate = calculateProjectEndDate();
            const totalProjectYears = modelType === 'monthly' 
                ? ((constructionPeriods + operationsPeriods) / 12).toFixed(1)
                : (constructionPeriods + operationsPeriods);
            
            // Determine which assets to show based on project type
            const showResidential = projectType === 'residential' || projectType === 'mixed-use';
            const showHospitality = projectType === 'hospitality' || projectType === 'mixed-use';
            const showRetail = true; // Always show retail
            
            // Area allocation validation - only count visible assets
            const totalAreaPercent = (showResidential ? residentialPercent : 0) + 
                                    (showHospitality ? hospitalityPercent : 0) + 
                                    retailPercent;
            const areaAllocationValid = Math.abs(totalAreaPercent - 100) < 0.01;
            
            // Residential
            const residentialTotalArea = (totalLandArea * residentialPercent) / 100;
            const residentialRoadsArea = (residentialTotalArea * residentialRoadsPercent) / 100;
            const residentialNetArea = residentialTotalArea - residentialRoadsArea;
            
            // GFA calculation based on selected base area
            const residentialGFABaseValue = residentialGFABase === 'totalAllocated' ? residentialTotalArea : residentialNetArea;
            const residentialGFA = residentialGFABaseValue * residentialFAR;
            
            // BUA calculation based on selected base area
            let residentialBUABaseValue;
            if (residentialBUABase === 'gfa') {
                residentialBUABaseValue = residentialGFA;
            } else if (residentialBUABase === 'netDevelopable') {
                residentialBUABaseValue = residentialNetArea;
            } else {
                residentialBUABaseValue = residentialTotalArea;
            }
            const residentialBUA = residentialBUABaseValue * residentialEfficiency;
            const residentialLandValue = residentialTotalArea * landValuePerSqm;
            
            // Hospitality
            const hospitalityTotalArea = (totalLandArea * hospitalityPercent) / 100;
            const hospitalityRoadsArea = (hospitalityTotalArea * hospitalityRoadsPercent) / 100;
            const hospitalityNetArea = hospitalityTotalArea - hospitalityRoadsArea;
            
            // GFA calculation based on selected base area
            const hospitalityGFABaseValue = hospitalityGFABase === 'totalAllocated' ? hospitalityTotalArea : hospitalityNetArea;
            const hospitalityGFA = hospitalityGFABaseValue * hospitalityFAR;
            
            // BUA calculation based on selected base area
            let hospitalityBUABaseValue;
            if (hospitalityBUABase === 'gfa') {
                hospitalityBUABaseValue = hospitalityGFA;
            } else if (hospitalityBUABase === 'netDevelopable') {
                hospitalityBUABaseValue = hospitalityNetArea;
            } else {
                hospitalityBUABaseValue = hospitalityTotalArea;
            }
            const hospitalityBUA = hospitalityBUABaseValue * hospitalityEfficiency;
            const hospitalityLandValue = hospitalityTotalArea * landValuePerSqm;
            
            // Retail
            const retailTotalArea = (totalLandArea * retailPercent) / 100;
            const retailRoadsArea = (retailTotalArea * retailRoadsPercent) / 100;
            const retailNetArea = retailTotalArea - retailRoadsArea;
            
            // GFA calculation based on selected base area
            const retailGFABaseValue = retailGFABase === 'totalAllocated' ? retailTotalArea : retailNetArea;
            const retailGFA = retailGFABaseValue * retailFAR;
            
            // BUA calculation based on selected base area
            let retailBUABaseValue;
            if (retailBUABase === 'gfa') {
                retailBUABaseValue = retailGFA;
            } else if (retailBUABase === 'netDevelopable') {
                retailBUABaseValue = retailNetArea;
            } else {
                retailBUABaseValue = retailTotalArea;
            }
            const retailBUA = retailBUABaseValue * retailEfficiency;
            const retailLandValue = retailTotalArea * landValuePerSqm;
            
            const formatNumber = (num) => {
                if (num === null || num === undefined || num === 0 || isNaN(num)) return '-';
                return Math.round(num).toLocaleString('en-US');
            };
            // For input display (never show dash, show actual value)
            const formatInput = (num) => {
                if (num === null || num === undefined || isNaN(num)) return '0';
                return Math.round(num).toLocaleString('en-US');
            };
            
            const formatCurrency = (num) => {
                if (!num || num === 0) return currency + ' 0';
                return currency + ' ' + Math.round(num).toLocaleString('en-US');
            };
            
            // ============ DEVELOPMENT COSTS HELPER FUNCTIONS ============

            const getAreas = (assetType) => ({
                residential: { totalAllocated:residentialTotalArea, netDevelopable:residentialNetArea, roadsArea:residentialRoadsArea, gfa:residentialGFA, bua:residentialBUA, landValue:residentialLandValue, cashLandValue:residentialTotalArea*landValuePerSqm*(cashPercent/100), inKindLandValue:residentialTotalArea*landValuePerSqm*(inKindPercent/100) },
                hospitality:  { totalAllocated:hospitalityTotalArea,  netDevelopable:hospitalityNetArea,  roadsArea:hospitalityRoadsArea,  gfa:hospitalityGFA,  bua:hospitalityBUA,  landValue:hospitalityLandValue,  cashLandValue:hospitalityTotalArea*landValuePerSqm*(cashPercent/100),  inKindLandValue:hospitalityTotalArea*landValuePerSqm*(inKindPercent/100) },
                retail:       { totalAllocated:retailTotalArea,       netDevelopable:retailNetArea,       roadsArea:retailRoadsArea,       gfa:retailGFA,       bua:retailBUA,       landValue:retailLandValue,       cashLandValue:retailTotalArea*landValuePerSqm*(cashPercent/100),       inKindLandValue:retailTotalArea*landValuePerSqm*(inKindPercent/100) },
            }[assetType]);

            const getMethodBase = (method, assetType) => {
                const a = getAreas(assetType);
                switch(method) {
                    case 'rate_total_allocated': return a.totalAllocated;
                    case 'rate_net_developable':  return a.netDevelopable;
                    case 'rate_roads':            return a.roadsArea;
                    case 'rate_gfa':              return a.gfa;
                    case 'rate_bua':              return a.bua;
                    default: return null;
                }
            };

            const getSelectedBase = (cost, costs, assetType) => {
                return (cost.selectedIds||[])
                    .filter(sid => sid !== cost.id)
                    .map(sid => costs.find(c => c.id === sid)).filter(Boolean)
                    .reduce((sum, c) => sum + calculateItemTotal(c, assetType, costs), 0);
            };

            const calculateItemTotal = (cost, assetType='residential', costsArr=null) => {
                const costs = costsArr || (assetType==='residential' ? residentialCosts : assetType==='hospitality' ? hospitalityCosts : retailCosts);
                const a = getAreas(assetType);
                const val = parseFloat(cost.value) || 0;
                switch(cost.method) {
                    case 'fixed':                return val;
                    case 'rate_total_allocated': return val * a.totalAllocated;
                    case 'rate_net_developable':  return val * a.netDevelopable;
                    case 'rate_roads':            return val * a.roadsArea;
                    case 'rate_gfa':              return val * a.gfa;
                    case 'rate_bua':              return val * a.bua;
                    case 'percent_base':          return getSelectedBase(cost, costs, assetType) * (val/100);
                    case 'percent_total_land':    return a.landValue * (val/100);
                    case 'percent_cash_land':     return a.cashLandValue * (val/100);
                    case 'percent_inkind_land':   return a.inKindLandValue * (val/100);
                    default: return 0;
                }
            };

            // Calculate percentage of base costs (legacy — kept for any old references)
            const calculatePercentBase = (cost, assetType='residential') => {
                const costs = assetType==='residential' ? residentialCosts : assetType==='hospitality' ? hospitalityCosts : retailCosts;
                return getSelectedBase(cost, costs, assetType) * ((parseFloat(cost.value)||0)/100);
            };



            // Distribute cost across periods based on phasing
            const distributeCost = (cost, assetType='residential') => {
                const total = calculateItemTotal(cost, assetType);
                const distribution = Array(constructionPeriods + 1).fill(0);
                if (cost.startPeriod === 0 && cost.endPeriod === 0) { distribution[0] = total; return distribution; }
                const phasingMode = getPhasingMode(cost);
                if (phasingMode === 'even') {
                    const cnt = cost.endPeriod - cost.startPeriod + 1;
                    const amt = cnt > 0 ? total/cnt : 0;
                    for (let i=cost.startPeriod; i<=cost.endPeriod && i<=constructionPeriods; i++) distribution[i]=amt;
                } else {
                    const pcts = getPhasingValues(cost);
                    pcts.forEach((pct,idx) => { const p=cost.startPeriod+idx; if(p<=constructionPeriods) distribution[p]=total*(pct/100); });
                }
                return distribution;
            };

            // Get phasing mode: 'even' or 'manual'
            const getPhasingMode = (cost) => {
                if (!cost.phasing) return 'even';
                if (typeof cost.phasing === 'object') return cost.phasing.type || 'even';
                if (cost.phasing.trim().toLowerCase() === 'even') return 'even';
                return 'manual';
            };

            // Get phasing values array (percentages)
            const getPhasingValues = (cost) => {
                if (typeof cost.phasing === 'object' && cost.phasing.values) return cost.phasing.values;
                if (typeof cost.phasing === 'string' && cost.phasing.trim().toLowerCase() !== 'even') {
                    return cost.phasing.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                }
                return [];
            };

            // Validate phasing
            const validatePhasingValues = (values, startPeriod, endPeriod) => {
                const periods = endPeriod - startPeriod + 1;
                if (values.length !== periods) return { valid:false, error:`Need ${periods} values` };
                const sum = values.reduce((a,b)=>a+b, 0);
                if (Math.abs(sum-100) > 0.01) return { valid:false, sum, error:`Sum: ${sum.toFixed(1)}%` };
                return { valid:true, sum, error:'' };
            };
            // Add new cost item
            const addResidentialCost = () => {
                const newCost = {
                    id: nextCostId,
                    name: 'New Cost Item',
                    method: 'fixed',
                    value: 0,
                    baseType: '',
                    selectedIds: [],
                    startPeriod: 1,
                    endPeriod: constructionPeriods,
                    phasing: 'even',
                    canDelete: true
                };
                setResidentialCosts([...residentialCosts, newCost]);
                setNextCostId(nextCostId + 1);
            };

            // Delete cost item
            const deleteResidentialCost = (id) => {
                setResidentialCosts(residentialCosts.filter(c => c.id !== id));
            };

            // Update cost item
            const updateResidentialCost = (id, field, value) => {
                setResidentialCosts(residentialCosts.map(cost => 
                    cost.id === id ? { ...cost, [field]: value } : cost
                ));
            };

            // Calculate CAPEX summary
            const calculateResidentialCapex = () => {
                const summary = residentialCosts.map(cost => ({
                    name: cost.name,
                    total: calculateItemTotal(cost, 'residential'),
                    distribution: distributeCost(cost, 'residential')
                }));

                // Calculate totals per period
                const periodTotals = Array(constructionPeriods + 1).fill(0);
                summary.forEach(item => {
                    item.distribution.forEach((amount, period) => {
                        periodTotals[period] += amount;
                    });
                });

                return { items: summary, totals: periodTotals };
            };

            const residentialCapex = calculateResidentialCapex();

            // Initialize default hospitality costs
            useEffect(() => {
                if (hospitalityCosts.length === 0) {
                    const hospitalityLandCash = (totalLandArea * cashPercent / 100) * (hospitalityPercent / 100) * landValuePerSqm;
                    setHospitalityCosts([
                        { id:1,  name:'Land (Cash Portion)',            method:'fixed',              value: hospitalityLandCash, baseType:'', selectedIds:[], startPeriod:0, endPeriod:0,                phasing:'100',             canDelete:false },
                        { id:2,  name:'Construction Cost',              method:'rate_bua',            value:1400,  baseType:'', selectedIds:[], startPeriod:7, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                        { id:3,  name:'Infrastructure Cost',            method:'rate_total_allocated',value:150,   baseType:'', selectedIds:[], startPeriod:1, endPeriod:6,                   phasing:'30,25,20,15,7,3', canDelete:true  },
                        { id:4,  name:'Landscaping Cost',               method:'rate_total_allocated',value:50,    baseType:'', selectedIds:[], startPeriod:1, endPeriod:6,                   phasing:'30,25,20,15,7,3', canDelete:true  },
                        { id:5,  name:'Pre-Operating Expenses',         method:'percent_base',        value:2,     baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:6,  name:'Professional Fee',               method:'percent_base',        value:5,     baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:7,  name:'Contingency Cost',               method:'percent_base',        value:3,     baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:8,  name:'Developer Fee / Performance Fee',method:'percent_base',        value:10,    baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:9,  name:'Electricity Station',            method:'fixed',               value:500000,baseType:'', selectedIds:[], startPeriod:3, endPeriod:8,                   phasing:'even',            canDelete:true  },
                        { id:10, name:'Bridges',                        method:'fixed',               value:750000,baseType:'', selectedIds:[], startPeriod:2, endPeriod:6,                   phasing:'even',            canDelete:true  },
                        { id:11, name:'Royal Commission Premium',       method:'percent_cash_land',   value:2.5,   baseType:'', selectedIds:[], startPeriod:0, endPeriod:0,                   phasing:'100',             canDelete:true  },
                        { id:12, name:'RETT',                           method:'percent_cash_land',   value:5,     baseType:'', selectedIds:[], startPeriod:0, endPeriod:0,                   phasing:'100',             canDelete:true  },
                    ]);
                }
            }, []);

            useEffect(() => {
                if (hospitalityCosts.length > 0) {
                    const v = (totalLandArea * cashPercent / 100) * (hospitalityPercent / 100) * landValuePerSqm;
                    setHospitalityCosts(prev => prev.map(c => c.id === 1 ? {...c, value: v} : c));
                }
            }, [totalLandArea, landValuePerSqm, cashPercent, hospitalityPercent]);

            // Initialize default retail costs
            useEffect(() => {
                if (retailCosts.length === 0) {
                    const retailLandCash = (totalLandArea * cashPercent / 100) * (retailPercent / 100) * landValuePerSqm;
                    setRetailCosts([
                        { id:1,  name:'Land (Cash Portion)',            method:'fixed',              value: retailLandCash, baseType:'', selectedIds:[], startPeriod:0, endPeriod:0,                phasing:'100',             canDelete:false },
                        { id:2,  name:'Construction Cost',              method:'rate_bua',            value:1000,  baseType:'', selectedIds:[], startPeriod:7, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                        { id:3,  name:'Infrastructure Cost',            method:'rate_total_allocated',value:150,   baseType:'', selectedIds:[], startPeriod:1, endPeriod:6,                   phasing:'30,25,20,15,7,3', canDelete:true  },
                        { id:4,  name:'Landscaping Cost',               method:'rate_total_allocated',value:50,    baseType:'', selectedIds:[], startPeriod:1, endPeriod:6,                   phasing:'30,25,20,15,7,3', canDelete:true  },
                        { id:5,  name:'Pre-Operating Expenses',         method:'percent_base',        value:2,     baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:6,  name:'Professional Fee',               method:'percent_base',        value:5,     baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:7,  name:'Contingency Cost',               method:'percent_base',        value:3,     baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:8,  name:'Developer Fee / Performance Fee',method:'percent_base',        value:10,    baseType:'infra_construction', selectedIds:[], startPeriod:1, endPeriod:constructionPeriods, phasing:'even', canDelete:true },
                        { id:9,  name:'Electricity Station',            method:'fixed',               value:500000,baseType:'', selectedIds:[], startPeriod:3, endPeriod:8,                   phasing:'even',            canDelete:true  },
                        { id:10, name:'Bridges',                        method:'fixed',               value:750000,baseType:'', selectedIds:[], startPeriod:2, endPeriod:6,                   phasing:'even',            canDelete:true  },
                        { id:11, name:'Royal Commission Premium',       method:'percent_cash_land',   value:2.5,   baseType:'', selectedIds:[], startPeriod:0, endPeriod:0,                   phasing:'100',             canDelete:true  },
                        { id:12, name:'RETT',                           method:'percent_cash_land',   value:5,     baseType:'', selectedIds:[], startPeriod:0, endPeriod:0,                   phasing:'100',             canDelete:true  },
                    ]);
                }
            }, []);

            useEffect(() => {
                if (retailCosts.length > 0) {
                    const v = (totalLandArea * cashPercent / 100) * (retailPercent / 100) * landValuePerSqm;
                    setRetailCosts(prev => prev.map(c => c.id === 1 ? {...c, value: v} : c));
                }
            }, [totalLandArea, landValuePerSqm, cashPercent, retailPercent]);

            // Hospitality CRUD
            const addHospitalityCost = () => {
                const newCost = { id: nextCostId, name: 'New Cost Item', method: 'fixed', value: 0, baseType: '', selectedIds: [], startPeriod: 1, endPeriod: constructionPeriods, phasing: 'even', canDelete: true };
                setHospitalityCosts([...hospitalityCosts, newCost]);
                setNextCostId(nextCostId + 1);
            };
            const deleteHospitalityCost = (id) => setHospitalityCosts(hospitalityCosts.filter(c => c.id !== id));
            const updateHospitalityCost = (id, field, value) => setHospitalityCosts(hospitalityCosts.map(c => c.id === id ? {...c, [field]: value} : c));
            const calculateHospitalityCapex = () => {
                const summary = hospitalityCosts.map(cost => ({ name: cost.name, total: calculateItemTotal(cost, 'hospitality'), distribution: distributeCost(cost, 'hospitality') }));
                const periodTotals = Array(constructionPeriods + 1).fill(0);
                summary.forEach(item => item.distribution.forEach((amt, p) => { periodTotals[p] += amt; }));
                return { items: summary, totals: periodTotals };
            };
            const hospitalityCapex = calculateHospitalityCapex();

            // Retail CRUD
            const addRetailCost = () => {
                const newCost = { id: nextCostId, name: 'New Cost Item', method: 'fixed', value: 0, baseType: '', selectedIds: [], startPeriod: 1, endPeriod: constructionPeriods, phasing: 'even', canDelete: true };
                setRetailCosts([...retailCosts, newCost]);
                setNextCostId(nextCostId + 1);
            };
            const deleteRetailCost = (id) => setRetailCosts(retailCosts.filter(c => c.id !== id));
            const updateRetailCost = (id, field, value) => setRetailCosts(retailCosts.map(c => c.id === id ? {...c, [field]: value} : c));
            const calculateRetailCapex = () => {
                const summary = retailCosts.map(cost => ({ name: cost.name, total: calculateItemTotal(cost, 'retail'), distribution: distributeCost(cost, 'retail') }));
                const periodTotals = Array(constructionPeriods + 1).fill(0);
                summary.forEach(item => item.distribution.forEach((amt, p) => { periodTotals[p] += amt; }));
                return { items: summary, totals: periodTotals };
            };
            const retailCapex = calculateRetailCapex();
            
            // Helper function to get base area name for display
            const getBaseAreaName = (baseAreaKey) => {
                const nameMap = {
                    'totalAllocated': 'Total Allocated Area',
                    'netDevelopable': 'Net Developable Area',
                    'gfa': 'GFA'
                };
                return nameMap[baseAreaKey] || baseAreaKey;
            };
            
            // Helper function to get base area value
            const getBaseAreaValue = (baseAreaKey, totalArea, netArea, gfaArea) => {
                if (baseAreaKey === 'totalAllocated') return totalArea;
                if (baseAreaKey === 'netDevelopable') return netArea;
                if (baseAreaKey === 'gfa') return gfaArea;
                return netArea;
            };
            
            // Add custom row function
            const addCustomRow = (sectionType) => {
                const newRow = {
                    id: Date.now(),
                    name: 'Custom Metric',
                    value: 0,
                    baseArea: 'netDevelopable',
                    multiplier: 1.0
                };
                
                if (sectionType === 'residential') {
                    setResidentialCustomRows([...residentialCustomRows, newRow]);
                } else if (sectionType === 'hospitality') {
                    setHospitalityCustomRows([...hospitalityCustomRows, newRow]);
                } else if (sectionType === 'retail') {
                    setRetailCustomRows([...retailCustomRows, newRow]);
                }
            };
            
            // Delete custom row function
            const deleteCustomRow = (sectionType, rowId) => {
                if (sectionType === 'residential') {
                    setResidentialCustomRows(residentialCustomRows.filter(row => row.id !== rowId));
                } else if (sectionType === 'hospitality') {
                    setHospitalityCustomRows(hospitalityCustomRows.filter(row => row.id !== rowId));
                } else if (sectionType === 'retail') {
                    setRetailCustomRows(retailCustomRows.filter(row => row.id !== rowId));
                }
            };
            
            // Update custom row
            const updateCustomRow = (sectionType, rowId, field, value) => {
                const updateRows = (rows) => rows.map(row => 
                    row.id === rowId ? { ...row, [field]: value } : row
                );
                
                if (sectionType === 'residential') {
                    setResidentialCustomRows(updateRows(residentialCustomRows));
                } else if (sectionType === 'hospitality') {
                    setHospitalityCustomRows(updateRows(hospitalityCustomRows));
                } else if (sectionType === 'retail') {
                    setRetailCustomRows(updateRows(retailCustomRows));
                }
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <div className="gradient-bg text-white p-6 shadow-lg">
                        <h1 className="text-3xl font-bold">Real Estate Financial Modeling Platform</h1>
                        <p className="text-sm opacity-90 mt-1">Module 1: Project Setup & Financial Structure</p>
                    </div>

                    {/* Navigation */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="container mx-auto px-6">
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setActiveModule('overview')}
                                    className={`px-6 py-4 font-semibold transition ${
                                        activeModule === 'overview' ? 'tab-active' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Overview
                                </button>
                                <button
                                    onClick={() => setActiveModule('module1')}
                                    className={`px-6 py-4 font-semibold transition ${
                                        activeModule === 'module1' ? 'tab-active' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Module 1
                                </button>

                            </div>
                        </div>
                    </div>

                    {/* Module 1 Content */}
                    {activeModule === 'overview' && (
                        <div className="container mx-auto px-6 py-6">
                            {/* Project Overview Dashboard */}
                            <div className="module-card p-8 mb-6">
                                <h2 className="text-3xl font-bold mb-6 text-gray-800">Project Overview</h2>
                                
                                <div className="grid grid-cols-3 gap-6 mb-8">
                                    <div className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                                        <div className="text-sm text-blue-600 font-medium mb-2">Project Name</div>
                                        <div className="text-2xl font-bold text-gray-800">{projectName}</div>
                                        <div className="text-sm text-gray-600 mt-1">{projectType.charAt(0).toUpperCase() + projectType.slice(1)}</div>
                                    </div>
                                    
                                    <div className="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                                        <div className="text-sm text-green-600 font-medium mb-2">Total Land Area</div>
                                        <div className="text-2xl font-bold text-gray-800">{formatNumber(totalLandArea)} sqm</div>
                                        <div className="text-sm text-gray-600 mt-1">Value: ${formatNumber(totalLandValue)}</div>
                                    </div>
                                    
                                    <div className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                                        <div className="text-sm text-purple-600 font-medium mb-2">Project Duration</div>
                                        <div className="text-2xl font-bold text-gray-800">
                                            {constructionPeriods + operationsPeriods} {modelType === 'monthly' ? 'Months' : 'Years'}
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            Construction: {constructionPeriods} | Operations: {operationsPeriods}
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-700 mb-4">Land Acquisition</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between p-3 bg-green-50 rounded">
                                                <span className="text-gray-700">Cash Purchase ({cashPercent}%)</span>
                                                <span className="font-bold text-green-700">${formatNumber(cashValue)}</span>
                                            </div>
                                            <div className="flex justify-between p-3 bg-blue-50 rounded">
                                                <span className="text-gray-700">In-Kind Contribution ({inKindPercent}%)</span>
                                                <span className="font-bold text-blue-700">${formatNumber(inKindValue)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-700 mb-4">Area Allocation</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between p-3 bg-blue-50 rounded">
                                                <span className="text-gray-700">Residential ({residentialPercent}%)</span>
                                                <span className="font-bold text-blue-700">{formatNumber(residentialTotalArea)} sqm</span>
                                            </div>
                                            <div className="flex justify-between p-3 bg-green-50 rounded">
                                                <span className="text-gray-700">Hospitality ({hospitalityPercent}%)</span>
                                                <span className="font-bold text-green-700">{formatNumber(hospitalityTotalArea)} sqm</span>
                                            </div>
                                            <div className="flex justify-between p-3 bg-purple-50 rounded">
                                                <span className="text-gray-700">Retail ({retailPercent}%)</span>
                                                <span className="font-bold text-purple-700">{formatNumber(retailTotalArea)} sqm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Module Navigation Cards */}
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">Financial Modeling Modules</h2>
                            <div className="grid grid-cols-3 gap-6">
                                {/* Module 1 - Active */}
                                <div className="module-card p-6 cursor-pointer border-2 border-purple-500" onClick={() => {
                                    setActiveModule('module1');
                                    setActiveTab('timeline');
                                }}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 1</h3>
                                        <span className="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">ACTIVE</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Project Setup & Financial Structure</p>
                                    <ul className="text-sm text-gray-600 space-y-2">
                                        <li>✓ Project Details & Timeline</li>
                                        <li>✓ Land & Area Allocation</li>
                                        <li>✓ Development Costs</li>
                                        <li>✓ Financing Structure</li>
                                    </ul>
                                    <button className="mt-4 w-full btn-primary text-white px-4 py-2 rounded-lg font-medium">
                                        Open Module
                                    </button>
                                </div>

                                {/* Module 2 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 2</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Revenue & Sales Projections</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• Unit Mix & Pricing</li>
                                        <li>• Sales Schedule</li>
                                        <li>• Revenue Recognition</li>
                                        <li>• Hospitality Revenue</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 3 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 3</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Operating Expenses & Cash Flow</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• OPEX Schedule</li>
                                        <li>• Property Management</li>
                                        <li>• Cash Flow Analysis</li>
                                        <li>• Working Capital</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 4 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 4</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Returns & Valuation Analysis</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• IRR Calculation</li>
                                        <li>• NPV Analysis</li>
                                        <li>• Exit Valuation</li>
                                        <li>• Sensitivity Analysis</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 5 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 5</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Financial Statements</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• Income Statement</li>
                                        <li>• Balance Sheet</li>
                                        <li>• Cash Flow Statement</li>
                                        <li>• Financial Ratios</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 6 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 6</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Reports & Visualizations</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• Executive Summary</li>
                                        <li>• Charts & Graphs</li>
                                        <li>• Export to PDF/Excel</li>
                                        <li>• Investor Presentations</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Module 1 Detailed View */}
                    {activeModule === 'module1' && (
                        <div className="container mx-auto px-6 py-6">
                            {/* Sub Navigation */}
                            <div className="sticky-nav bg-white rounded-lg shadow-sm p-2 mb-6 flex gap-2">
                                <button
                                    onClick={() => setActiveTab('timeline')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'timeline' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Project Details & Timeline
                                </button>
                                <button
                                    onClick={() => setActiveTab('area')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'area' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Land & Area
                                </button>
                                <button
                                    onClick={() => setActiveTab('costs')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'costs' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Development Costs
                                </button>

                                <button
                                    onClick={() => setActiveTab('financing')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'financing' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Financing
                                </button>
                            </div>

                            <div>
                                {/* Timeline Tab */}
                                {activeTab === 'timeline' && (
                                    <div className="module-card p-6">
                                        <h3 className="text-2xl font-bold mb-6 text-gray-800">Project Details & Timeline</h3>
                                        
                                        <div className="grid grid-cols-2 gap-6 mb-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                                <input
                                                    type="text"
                                                    value={projectName}
                                                    onChange={(e) => setProjectName(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                                                <div className="flex gap-2">
                                                    {['residential','hospitality','mixed-use'].map(pt => (
                                                        <button key={pt} onClick={() => setProjectType(pt)}
                                                            className={`flex-1 px-3 py-2 rounded-lg font-medium text-sm transition ${projectType === pt ? 'btn-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                            {pt === 'mixed-use' ? 'Mixed-Use' : pt.charAt(0).toUpperCase() + pt.slice(1)}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                                <input
                                                    type="text"
                                                    value={country}
                                                    onChange={(e) => setCountry(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                    placeholder="e.g., United States, UAE, UK"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                                                <select
                                                    value={currency}
                                                    onChange={(e) => setCurrency(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                >
                                                    <option value="USD">USD - US Dollar</option>
                                                    <option value="AED">AED - UAE Dirham</option>
                                                    <option value="EUR">EUR - Euro</option>
                                                    <option value="GBP">GBP - British Pound</option>
                                                    <option value="SAR">SAR - Saudi Riyal</option>
                                                    <option value="PKR">PKR - Pakistani Rupee</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Model Type</label>
                                                <div className="flex gap-2">
                                                    <button onClick={() => handleModelTypeChange('monthly')}
                                                        className={`flex-1 px-4 py-2 rounded-lg font-medium transition ${modelType === 'monthly' ? 'btn-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                        Monthly
                                                    </button>
                                                    <button onClick={() => handleModelTypeChange('annual')}
                                                        className={`flex-1 px-4 py-2 rounded-lg font-medium transition ${modelType === 'annual' ? 'btn-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                        Annual
                                                    </button>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Project Start Date</label>
                                                <input
                                                    type="date"
                                                    value={projectStart}
                                                    onChange={(e) => setProjectStart(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Construction Periods ({modelType === 'monthly' ? 'Months' : 'Years'})
                                                </label>
                                                <input
                                                    type="number"
                                                    value={constructionPeriods}
                                                    onChange={(e) => setConstructionPeriods(parseInt(e.target.value) || 0)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Operations Periods ({modelType === 'monthly' ? 'Months' : 'Years'})
                                                </label>
                                                <input
                                                    type="number"
                                                    value={operationsPeriods}
                                                    onChange={(e) => setOperationsPeriods(parseInt(e.target.value) || 0)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                        </div>

                                        {/* Results Display */}
                                        <div className="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border border-purple-200">
                                            <h4 className="font-bold text-gray-800 mb-4">Project Timeline Summary</h4>
                                            <div className="grid grid-cols-3 gap-6">
                                                <div>
                                                    <div className="text-sm text-gray-600 mb-1">Total Project Duration</div>
                                                    <div className="text-2xl font-bold text-purple-700">
                                                        {constructionPeriods + operationsPeriods} {modelType === 'monthly' ? 'Months' : 'Years'}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Construction: {constructionPeriods} | Operations: {operationsPeriods}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-gray-600 mb-1">Project End Date</div>
                                                    <div className="text-2xl font-bold text-blue-700">
                                                        {new Date(projectEndDate).toLocaleDateString('en-US', { 
                                                            month: 'short', 
                                                            day: 'numeric', 
                                                            year: 'numeric' 
                                                        })}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        From: {new Date(projectStart).toLocaleDateString('en-US', { 
                                                            month: 'short', 
                                                            year: 'numeric' 
                                                        })}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-gray-600 mb-1">Total Project Period</div>
                                                    <div className="text-2xl font-bold text-green-700">
                                                        {totalProjectYears} Years
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Model: {modelType === 'monthly' ? 'Monthly' : 'Annual'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Area Tab - With detailed calculations and validation */}
                                {activeTab === 'area' && (
                                    <div className="module-card p-6">
                                        <h3 className="text-2xl font-bold mb-6 text-gray-800">Land & Area Allocation</h3>
                                        
                                        {/* Land Acquisition Section */}
                                        <div className="mb-8">
                                            <h4 className="text-lg font-bold text-gray-700 mb-4">Land Acquisition</h4>
                                            <div className="grid grid-cols-4 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Total Land Area (sqm)</label>
                                                    <input
                                                        type="number"
                                                        value={totalLandArea}
                                                        onChange={(e) => setTotalLandArea(parseFloat(e.target.value) || 0)}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Land Value (per sqm)</label>
                                                    <input
                                                        type="number"
                                                        value={landValuePerSqm}
                                                        onChange={(e) => setLandValuePerSqm(parseFloat(e.target.value) || 0)}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Cash %</label>
                                                    <input
                                                        type="number"
                                                        value={cashPercent}
                                                        onChange={(e) => {
                                                            const val = parseFloat(e.target.value) || 0;
                                                            setCashPercent(val);
                                                            setInKindPercent(100 - val);
                                                        }}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        min="0"
                                                        max="100"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">In-Kind %</label>
                                                    <input
                                                        type="number"
                                                        value={inKindPercent}
                                                        onChange={(e) => {
                                                            const val = parseFloat(e.target.value) || 0;
                                                            setInKindPercent(val);
                                                            setCashPercent(100 - val);
                                                        }}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        min="0"
                                                        max="100"
                                                    />
                                                </div>
                                            </div>
                                            
                                            {/* Land Value Summary Table */}
                                            <div className="mt-4">
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="bg-gray-700 text-white">
                                                            <th className="p-2 text-left">Description</th>
                                                            <th className="p-2 text-right">Value ({currency})</th>
                                                            <th className="p-2 text-left">Calculation</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr className="bg-white">
                                                            <td className="p-2 border">Total Land Value</td>
                                                            <td className="p-2 border text-right font-bold">{formatNumber(totalLandValue)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {currency} {formatNumber(landValuePerSqm)}/sqm</td>
                                                        </tr>
                                                        <tr className="bg-green-50">
                                                            <td className="p-2 border">Cash Purchase</td>
                                                            <td className="p-2 border text-right font-bold text-green-700">{formatNumber(cashValue)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandValue)} × {cashPercent}%</td>
                                                        </tr>
                                                        <tr className="bg-blue-50">
                                                            <td className="p-2 border">In-Kind Contribution</td>
                                                            <td className="p-2 border text-right font-bold text-gray-800">{formatNumber(inKindValue)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandValue)} × {inKindPercent}%</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        {/* Area Allocation by Asset */}
                                        <div className="mb-6">
                                            <h4 className="text-lg font-bold text-gray-700 mb-4">Area Allocation by Asset</h4>
                                            
                                            <div className="grid grid-cols-3 gap-4 mb-4">
                                                {showResidential && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Residential %</label>
                                                        <input
                                                            type="number"
                                                            value={residentialPercent}
                                                            onChange={(e) => setResidentialPercent(parseFloat(e.target.value) || 0)}
                                                            className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        />
                                                    </div>
                                                )}
                                                {showHospitality && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Hospitality %</label>
                                                        <input
                                                            type="number"
                                                            value={hospitalityPercent}
                                                            onChange={(e) => setHospitalityPercent(parseFloat(e.target.value) || 0)}
                                                            className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        />
                                                    </div>
                                                )}
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Retail %</label>
                                                    <input
                                                        type="number"
                                                        value={retailPercent}
                                                        onChange={(e) => setRetailPercent(parseFloat(e.target.value) || 0)}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                            </div>

                                            {/* Validation Warning */}
                                            <div className={`p-3 rounded-lg mb-4 ${areaAllocationValid ? 'bg-green-50 border border-green-300' : 'bg-red-50 border border-red-300'}`}>
                                                <div className="flex items-center justify-between">
                                                    <span className={`font-medium ${areaAllocationValid ? 'text-green-700' : 'text-red-700'}`}>
                                                        Total Allocation: {totalAreaPercent.toFixed(1)}%
                                                    </span>
                                                    {areaAllocationValid ? (
                                                        <span className="text-green-700 font-bold">✓ Valid (100%)</span>
                                                    ) : (
                                                        <span className="text-red-700 font-bold">
                                                            ⚠ Error: Must equal 100% (Currently {totalAreaPercent > 100 ? 'over' : 'under'} by {Math.abs(100 - totalAreaPercent).toFixed(1)}%)
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Residential Breakdown */}
                                        {showResidential && (
                                            <div className="mb-6">
                                                <h4 className="text-lg font-bold text-gray-700 mb-3">Residential - Area Breakdown</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Metric</th>
                                                                <th className="p-2 text-center">Input</th>
                                                                <th className="p-2 text-center">Base Area</th>
                                                                <th className="p-2 text-right">Value (sqm)</th>
                                                                <th className="p-2 text-left">Calculation</th>
                                                                <th className="p-2 text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-blue-50">
                                                                <td className="p-2 border font-medium">Total Allocated Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialTotalArea)}</td>
                                                                <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {residentialPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Roads/Open Area</td>
                                                                <td className="p-2 border text-center">
                                                                    <input
                                                                        type="number"
                                                                        value={residentialRoadsPercent}
                                                                        onChange={(e) => setResidentialRoadsPercent(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right text-gray-900">{formatNumber(residentialRoadsArea)}</td>
                                                                <td className="p-2 border">{formatNumber(residentialTotalArea)} sqm × {residentialRoadsPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-green-100">
                                                                <td className="p-2 border font-bold">Net Developable Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialNetArea)}</td>
                                                                <td className="p-2 border">{formatNumber(residentialTotalArea)} - {formatNumber(residentialRoadsArea)}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">GFA (Gross Floor Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    FAR: <input
                                                                        type="number"
                                                                        value={residentialFAR}
                                                                        onChange={(e) => setResidentialFAR(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        step="0.1"
                                                                        min="0"
                                                                    />
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={residentialGFABase}
                                                                        onChange={(e) => setResidentialGFABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialGFA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(residentialGFABase)} × {residentialFAR}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-blue-100">
                                                                <td className="p-2 border font-bold">BUA (Built-Up Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    Eff: <input
                                                                        type="number"
                                                                        value={(residentialEfficiency * 100).toFixed(0)}
                                                                        onChange={(e) => setResidentialEfficiency(parseFloat(e.target.value) / 100 || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={residentialBUABase}
                                                                        onChange={(e) => setResidentialBUABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="gfa">GFA</option>
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialBUA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(residentialBUABase)} × {(residentialEfficiency * 100).toFixed(0)}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            
                                                            {/* Custom Rows */}
                                                            {residentialCustomRows.map((customRow) => {
                                                                const baseValue = getBaseAreaValue(customRow.baseArea, residentialTotalArea, residentialNetArea, residentialGFA);
                                                                const calculatedValue = baseValue * customRow.multiplier;
                                                                
                                                                return (
                                                                    <tr key={customRow.id} className="bg-yellow-50">
                                                                        <td className="p-2 border">
                                                                            <input
                                                                                type="text"
                                                                                value={customRow.name}
                                                                                onChange={(e) => updateCustomRow('residential', customRow.id, 'name', e.target.value)}
                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <input
                                                                                type="number"
                                                                                value={customRow.multiplier}
                                                                                onChange={(e) => updateCustomRow('residential', customRow.id, 'multiplier', parseFloat(e.target.value) || 0)}
                                                                                className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                                step="0.1"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <select 
                                                                                value={customRow.baseArea}
                                                                                onChange={(e) => updateCustomRow('residential', customRow.id, 'baseArea', e.target.value)}
                                                                                className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                            >
                                                                                <option value="totalAllocated">Total Allocated Area</option>
                                                                                <option value="netDevelopable">Net Developable Area</option>
                                                                                <option value="gfa">GFA</option>
                                                                            </select>
                                                                        </td>
                                                                        <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(calculatedValue)}</td>
                                                                        <td className="p-2 border">{getBaseAreaName(customRow.baseArea)} × {customRow.multiplier}</td>
                                                                        <td className="p-2 border text-center">
                                                                            <button 
                                                                                onClick={() => deleteCustomRow('residential', customRow.id)}
                                                                                className="text-red-600 hover:text-red-800 text-sm font-bold"
                                                                            >
                                                                                🗑️
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    <div className="mt-3">
                                                        <button 
                                                            onClick={() => addCustomRow('residential')}
                                                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                                        >
                                                            + Add Row
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Hospitality Breakdown */}
                                        {showHospitality && (
                                            <div className="mb-6">
                                                <h4 className="text-lg font-bold text-gray-700 mb-3">Hospitality - Area Breakdown</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Metric</th>
                                                                <th className="p-2 text-center">Input</th>
                                                                <th className="p-2 text-center">Base Area</th>
                                                                <th className="p-2 text-right">Value (sqm)</th>
                                                                <th className="p-2 text-left">Calculation</th>
                                                                <th className="p-2 text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-green-50">
                                                                <td className="p-2 border font-medium">Total Allocated Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityTotalArea)}</td>
                                                                <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {hospitalityPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Roads/Open Area</td>
                                                                <td className="p-2 border text-center">
                                                                    <input
                                                                        type="number"
                                                                        value={hospitalityRoadsPercent}
                                                                        onChange={(e) => setHospitalityRoadsPercent(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right text-gray-900">{formatNumber(hospitalityRoadsArea)}</td>
                                                                <td className="p-2 border">{formatNumber(hospitalityTotalArea)} sqm × {hospitalityRoadsPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-green-100">
                                                                <td className="p-2 border font-bold">Net Developable Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityNetArea)}</td>
                                                                <td className="p-2 border">{formatNumber(hospitalityTotalArea)} - {formatNumber(hospitalityRoadsArea)}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">GFA (Gross Floor Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    FAR: <input
                                                                        type="number"
                                                                        value={hospitalityFAR}
                                                                        onChange={(e) => setHospitalityFAR(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        step="0.1"
                                                                        min="0"
                                                                    />
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={hospitalityGFABase}
                                                                        onChange={(e) => setHospitalityGFABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityGFA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(hospitalityGFABase)} × {hospitalityFAR}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-green-100">
                                                                <td className="p-2 border font-bold">BUA (Built-Up Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    Eff: <input
                                                                        type="number"
                                                                        value={(hospitalityEfficiency * 100).toFixed(0)}
                                                                        onChange={(e) => setHospitalityEfficiency(parseFloat(e.target.value) / 100 || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={hospitalityBUABase}
                                                                        onChange={(e) => setHospitalityBUABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="gfa">GFA</option>
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityBUA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(hospitalityBUABase)} × {(hospitalityEfficiency * 100).toFixed(0)}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            
                                                            {/* Custom Rows */}
                                                            {hospitalityCustomRows.map((customRow) => {
                                                                const baseValue = getBaseAreaValue(customRow.baseArea, hospitalityTotalArea, hospitalityNetArea, hospitalityGFA);
                                                                const calculatedValue = baseValue * customRow.multiplier;
                                                                
                                                                return (
                                                                    <tr key={customRow.id} className="bg-yellow-50">
                                                                        <td className="p-2 border">
                                                                            <input
                                                                                type="text"
                                                                                value={customRow.name}
                                                                                onChange={(e) => updateCustomRow('hospitality', customRow.id, 'name', e.target.value)}
                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <input
                                                                                type="number"
                                                                                value={customRow.multiplier}
                                                                                onChange={(e) => updateCustomRow('hospitality', customRow.id, 'multiplier', parseFloat(e.target.value) || 0)}
                                                                                className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                                step="0.1"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <select 
                                                                                value={customRow.baseArea}
                                                                                onChange={(e) => updateCustomRow('hospitality', customRow.id, 'baseArea', e.target.value)}
                                                                                className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                            >
                                                                                <option value="totalAllocated">Total Allocated Area</option>
                                                                                <option value="netDevelopable">Net Developable Area</option>
                                                                                <option value="gfa">GFA</option>
                                                                            </select>
                                                                        </td>
                                                                        <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(calculatedValue)}</td>
                                                                        <td className="p-2 border">{getBaseAreaName(customRow.baseArea)} × {customRow.multiplier}</td>
                                                                        <td className="p-2 border text-center">
                                                                            <button 
                                                                                onClick={() => deleteCustomRow('hospitality', customRow.id)}
                                                                                className="text-red-600 hover:text-red-800 text-sm font-bold"
                                                                            >
                                                                                🗑️
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    <div className="mt-3">
                                                        <button 
                                                            onClick={() => addCustomRow('hospitality')}
                                                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                                        >
                                                            + Add Row
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Retail Breakdown */}
                                        <div className="mb-6">
                                            <h4 className="text-lg font-bold text-gray-700 mb-3">Retail - Area Breakdown</h4>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="bg-gray-700 text-white">
                                                            <th className="p-2 text-left">Metric</th>
                                                            <th className="p-2 text-center">Input</th>
                                                            <th className="p-2 text-center">Base Area</th>
                                                            <th className="p-2 text-right">Value (sqm)</th>
                                                            <th className="p-2 text-left">Calculation</th>
                                                            <th className="p-2 text-center">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr className="bg-purple-50">
                                                            <td className="p-2 border font-medium">Total Allocated Area</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailTotalArea)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {retailPercent}%</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-white">
                                                            <td className="p-2 border">Roads/Open Area</td>
                                                            <td className="p-2 border text-center">
                                                                <input
                                                                    type="number"
                                                                    value={retailRoadsPercent}
                                                                    onChange={(e) => setRetailRoadsPercent(parseFloat(e.target.value) || 0)}
                                                                    className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                    min="0"
                                                                    max="100"
                                                                /> %
                                                            </td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-right text-gray-900">{formatNumber(retailRoadsArea)}</td>
                                                            <td className="p-2 border">{formatNumber(retailTotalArea)} sqm × {retailRoadsPercent}%</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-purple-100">
                                                            <td className="p-2 border font-bold">Net Developable Area</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailNetArea)}</td>
                                                            <td className="p-2 border">{formatNumber(retailTotalArea)} - {formatNumber(retailRoadsArea)}</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-white">
                                                            <td className="p-2 border">GFA (Gross Floor Area)</td>
                                                            <td className="p-2 border text-center">
                                                                FAR: <input
                                                                    type="number"
                                                                    value={retailFAR}
                                                                    onChange={(e) => setRetailFAR(parseFloat(e.target.value) || 0)}
                                                                    className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                    step="0.1"
                                                                    min="0"
                                                                />
                                                            </td>
                                                            <td className="p-2 border text-center">
                                                                <select 
                                                                    value={retailGFABase}
                                                                    onChange={(e) => setRetailGFABase(e.target.value)}
                                                                    className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                >
                                                                    <option value="netDevelopable">Net Developable Area</option>
                                                                    <option value="totalAllocated">Total Allocated Area</option>
                                                                </select>
                                                            </td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailGFA)}</td>
                                                            <td className="p-2 border">{getBaseAreaName(retailGFABase)} × {retailFAR}</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-purple-100">
                                                            <td className="p-2 border font-bold">BUA (Built-Up Area)</td>
                                                            <td className="p-2 border text-center">
                                                                Eff: <input
                                                                    type="number"
                                                                    value={(retailEfficiency * 100).toFixed(0)}
                                                                    onChange={(e) => setRetailEfficiency(parseFloat(e.target.value) / 100 || 0)}
                                                                    className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                    min="0"
                                                                    max="100"
                                                                /> %
                                                            </td>
                                                            <td className="p-2 border text-center">
                                                                <select 
                                                                    value={retailBUABase}
                                                                    onChange={(e) => setRetailBUABase(e.target.value)}
                                                                    className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                >
                                                                    <option value="gfa">GFA</option>
                                                                    <option value="netDevelopable">Net Developable Area</option>
                                                                    <option value="totalAllocated">Total Allocated Area</option>
                                                                </select>
                                                            </td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailBUA)}</td>
                                                            <td className="p-2 border">{getBaseAreaName(retailBUABase)} × {(retailEfficiency * 100).toFixed(0)}%</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        
                                                        {/* Custom Rows */}
                                                        {retailCustomRows.map((customRow) => {
                                                            const baseValue = getBaseAreaValue(customRow.baseArea, retailTotalArea, retailNetArea, retailGFA);
                                                            const calculatedValue = baseValue * customRow.multiplier;
                                                            
                                                            return (
                                                                <tr key={customRow.id} className="bg-yellow-50">
                                                                    <td className="p-2 border">
                                                                        <input
                                                                            type="text"
                                                                            value={customRow.name}
                                                                            onChange={(e) => updateCustomRow('retail', customRow.id, 'name', e.target.value)}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                        />
                                                                    </td>
                                                                    <td className="p-2 border text-center">
                                                                        <input
                                                                            type="number"
                                                                            value={customRow.multiplier}
                                                                            onChange={(e) => updateCustomRow('retail', customRow.id, 'multiplier', parseFloat(e.target.value) || 0)}
                                                                            className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                            step="0.1"
                                                                        />
                                                                    </td>
                                                                    <td className="p-2 border text-center">
                                                                        <select 
                                                                            value={customRow.baseArea}
                                                                            onChange={(e) => updateCustomRow('retail', customRow.id, 'baseArea', e.target.value)}
                                                                            className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                        >
                                                                            <option value="totalAllocated">Total Allocated Area</option>
                                                                            <option value="netDevelopable">Net Developable Area</option>
                                                                            <option value="gfa">GFA</option>
                                                                        </select>
                                                                    </td>
                                                                    <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(calculatedValue)}</td>
                                                                    <td className="p-2 border">{getBaseAreaName(customRow.baseArea)} × {customRow.multiplier}</td>
                                                                    <td className="p-2 border text-center">
                                                                        <button 
                                                                            onClick={() => deleteCustomRow('retail', customRow.id)}
                                                                            className="text-red-600 hover:text-red-800 text-sm font-bold"
                                                                        >
                                                                            🗑️
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                                <div className="mt-3">
                                                    <button 
                                                        onClick={() => addCustomRow('retail')}
                                                        className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                                    >
                                                        + Add Row
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

    
                            {/* Development Costs Tab */}
                            {activeTab === 'costs' && (
                                <div className="space-y-8">
                                {/* RESIDENTIAL DEVELOPMENT COSTS */}
                                {showResidential && (
                                    <div className="module-card p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-blue-800">RESIDENTIAL DEVELOPMENT COSTS</h2>
                                            <span className="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">All figures in {currency}</span>
                                        </div>

                                        {/* Cost Input Table */}
                                        <div className="overflow-x-auto mb-4">
                                            <table className="w-full text-sm border-collapse" style={{minWidth:'1200px'}}>
                                                <thead>
                                                    <tr className="bg-gray-700 text-white text-xs">
                                                        <th className="p-2 text-left" style={{minWidth:'150px'}}>Cost Item Name</th>
                                                        <th className="p-2 text-left" style={{minWidth:'220px'}}>Calculation Method</th>
                                                        <th className="p-2 text-right" style={{minWidth:'120px'}}>Area / Base Value</th>
                                                        <th className="p-2 text-right" style={{minWidth:'90px'}}>Input Value</th>
                                                        <th className="p-2 text-right" style={{minWidth:'110px'}}>Total Cost</th>
                                                        <th className="p-2 text-center" style={{minWidth:'75px'}}>Start Period</th>
                                                        <th className="p-2 text-center" style={{minWidth:'75px'}}>End Period</th>
                                                        <th className="p-2 text-left" style={{minWidth:'200px'}}>Period Wise Allocation %</th>
                                                        <th className="p-2 text-center" style={{minWidth:'40px'}}></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                                                                {/* Row body */}
                                                {residentialCosts.map((cost, idx) => {
                                                    const isLand  = cost.id === 1;
                                                    const isRate  = cost.method.startsWith('rate_');
                                                    const isPct   = cost.method === 'percent_base';
                                                    const areaVal = isRate ? getMethodBase(cost.method, 'residential') : null;
                                                    const baseVal = isPct  ? getSelectedBase(cost, residentialCosts, 'residential') : null;
                                                    const total   = calculateItemTotal(cost, 'residential');
                                                    const otherCosts = residentialCosts.filter(c => c.id !== cost.id);
                                                    const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                                    const a = getAreas('residential');
                                                    return (
                                                        <tr key={cost.id} className={rowBg}>

                                                            {/* Cost Item Name */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                <input type="text" value={cost.name}
                                                                    onChange={e => updateResidentialCost(cost.id, 'name', e.target.value)}
                                                                    disabled={isLand}
                                                                    className={`w-full px-2 py-1 border rounded text-xs ${isLand ? 'bg-gray-100 text-gray-500 border-gray-200 cursor-not-allowed' : 'border-yellow-300'}`}
                                                                />
                                                            </td>

                                                            {/* Calculation Method */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-400 italic">Fixed (Auto-calculated)</span>
                                                                ) : (
                                                                    <div>
                                                                        <select value={cost.method}
                                                                            onChange={e => updateResidentialCost(cost.id, 'method', e.target.value)}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs mb-1">
                                                                            <optgroup label="── Fixed ──">
                                                                                <option value="fixed">Fixed Amount</option>
                                                                            </optgroup>
                                                                            <optgroup label="── Rate (×Area sqm) ──">
                                                                                <option value="rate_total_allocated">Total Allocated Area</option>
                                                                                <option value="rate_net_developable">Net Developable Area</option>
                                                                                <option value="rate_roads">Roads Area</option>
                                                                                <option value="rate_gfa">GFA</option>
                                                                                <option value="rate_bua">BUA</option>
                                                                            </optgroup>
                                                                            <optgroup label="── Percentage of ──">
                                                                                <option value="percent_base">% of Selected Costs ▾</option>
                                                                                <option value="percent_total_land">% of Total Land Cost</option>
                                                                                <option value="percent_cash_land">% of Cash Land Value</option>
                                                                                <option value="percent_inkind_land">% of In-Kind Land Value</option>
                                                                            </optgroup>
                                                                        </select>
                                                                        {isPct && (
                                                                            <div className="border border-blue-200 rounded bg-white shadow-sm" style={{maxHeight:'110px', overflowY:'auto', fontSize:'0.68rem'}}>
                                                                                {otherCosts.length === 0
                                                                                    ? <div className="text-gray-400 px-2 py-1 italic">No other items yet</div>
                                                                                    : otherCosts.map(oc => (
                                                                                        <label key={oc.id} className="flex items-center gap-1.5 px-2 py-0.5 hover:bg-blue-50 cursor-pointer">
                                                                                            <input type="checkbox"
                                                                                                checked={(cost.selectedIds||[]).includes(oc.id)}
                                                                                                onChange={e => {
                                                                                                    const sel = cost.selectedIds || [];
                                                                                                    updateResidentialCost(cost.id, 'selectedIds',
                                                                                                        e.target.checked ? [...sel, oc.id] : sel.filter(x => x !== oc.id));
                                                                                                }}
                                                                                            />
                                                                                            <span className="text-gray-700">{oc.name}</span>
                                                                                        </label>
                                                                                    ))
                                                                                }
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Area / Base Value */}
                                                            <td className="p-2 border-b border-gray-200 text-right text-xs">
                                                                {isLand && <span className="text-gray-400 italic">—</span>}
                                                                {isRate && <span className="font-semibold text-blue-700">{formatInput(areaVal)} sqm</span>}
                                                                {isPct  && <span className="font-semibold text-purple-700">{formatNumber(baseVal)}</span>}
                                                                {cost.method === 'percent_total_land'  && <span className="font-semibold text-green-700">{formatNumber(a.landValue)}</span>}
                                                                {cost.method === 'percent_cash_land'   && <span className="font-semibold text-green-700">{formatNumber(a.cashLandValue)}</span>}
                                                                {cost.method === 'percent_inkind_land' && <span className="font-semibold text-green-700">{formatNumber(a.inKindLandValue)}</span>}
                                                                {cost.method === 'fixed' && !isLand && <span className="text-gray-400 italic">—</span>}
                                                            </td>

                                                            {/* Input Value */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-500 text-right block">{formatNumber(cost.value)}</span>
                                                                ) : (
                                                                    <div className="flex items-center gap-0.5 justify-end">
                                                                        {isPct || cost.method.startsWith('percent_') ? <span className="text-gray-500 text-xs">%</span> : isRate ? <span className="text-gray-500 text-xs">$/sqm</span> : null}
                                                                        <input type="number" value={cost.value}
                                                                            onChange={e => updateResidentialCost(cost.id, 'value', parseFloat(e.target.value)||0)}
                                                                            className="w-20 px-2 py-1 border border-yellow-300 rounded text-xs text-right"
                                                                        />
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Total Cost */}
                                                            <td className="p-2 border-b border-gray-200 text-right font-bold text-blue-900 text-sm">
                                                                {formatNumber(total)}
                                                            </td>

                                                            {/* Start Period */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {isLand ? <span className="text-xs text-gray-400">0</span> : (
                                                                    <input type="number" value={cost.startPeriod} min="0" max={constructionPeriods}
                                                                        onChange={e => updateResidentialCost(cost.id, 'startPeriod', parseInt(e.target.value)||0)}
                                                                        className="w-14 px-1 py-1 border border-yellow-300 rounded text-xs text-center"/>
                                                                )}
                                                            </td>

                                                            {/* End Period */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {isLand ? <span className="text-xs text-gray-400">0</span> : (
                                                                    <input type="number" value={cost.endPeriod} min="0" max={constructionPeriods}
                                                                        onChange={e => updateResidentialCost(cost.id, 'endPeriod', parseInt(e.target.value)||0)}
                                                                        className="w-14 px-1 py-1 border border-yellow-300 rounded text-xs text-center"/>
                                                                )}
                                                            </td>

                                                            {/* Period Wise Allocation % */}
                                                            <td className="p-2 border-b border-gray-200" style={{minWidth:'200px'}}>
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-400">100% (Period 0)</span>
                                                                ) : (
                                                                    <div>
                                                                        <select
                                                                            value={getPhasingMode(cost)}
                                                                            onChange={e => {
                                                                                const mode = e.target.value;
                                                                                if (mode === 'even') {
                                                                                    updateResidentialCost(cost.id, 'phasing', 'even');
                                                                                } else {
                                                                                    const cnt = Math.max(1, cost.endPeriod - cost.startPeriod + 1);
                                                                                    updateResidentialCost(cost.id, 'phasing', {type:'manual', values: Array(cnt).fill(0)});
                                                                                }
                                                                            }}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs mb-1"
                                                                        >
                                                                            <option value="even">Even Distribution</option>
                                                                            <option value="manual">Manual Allocation %</option>
                                                                        </select>
                                                                        {getPhasingMode(cost) === 'manual' && (() => {
                                                                            const cnt = Math.max(1, cost.endPeriod - cost.startPeriod + 1);
                                                                            const vals = getPhasingValues(cost);
                                                                            const filledVals = Array(cnt).fill(0).map((_, i) => vals[i] !== undefined ? vals[i] : 0);
                                                                            const validation = validatePhasingValues(filledVals, cost.startPeriod, cost.endPeriod);
                                                                            const totalPct = filledVals.reduce((a,b)=>a+b,0);
                                                                            return (
                                                                                <div className="border border-gray-200 rounded bg-gray-50 p-1" style={{overflowX:'auto'}}>
                                                                                    <table className="text-xs" style={{minWidth: Math.max(200, cnt*55)+'px'}}>
                                                                                        <thead>
                                                                                            <tr className="bg-gray-200">
                                                                                                <td className="px-1 py-0.5 font-semibold text-gray-600 whitespace-nowrap">Period</td>
                                                                                                <td className="px-1 py-0.5 font-semibold text-center text-gray-600 whitespace-nowrap">Total</td>
                                                                                                {filledVals.map((_, i) => (
                                                                                                    <td key={i} className="px-1 py-0.5 font-semibold text-center text-gray-600 whitespace-nowrap">
                                                                                                        {modelType==='monthly'?'M':'Y'}{cost.startPeriod+i}
                                                                                                    </td>
                                                                                                ))}
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            <tr>
                                                                                                <td className="px-1 py-0.5 text-gray-500 whitespace-nowrap">Alloc %</td>
                                                                                                <td className={`px-1 py-0.5 text-center font-bold whitespace-nowrap ${!validation.valid?'text-red-600':'text-green-700'}`}>
                                                                                                    {totalPct.toFixed(1)}%
                                                                                                </td>
                                                                                                {filledVals.map((v,i) => (
                                                                                                    <td key={i} className="px-0.5 py-0.5">
                                                                                                        <input type="number" value={v} min="0" max="100" step="0.1"
                                                                                                            onChange={e => {
                                                                                                                const nv=[...filledVals]; nv[i]=parseFloat(e.target.value)||0;
                                                                                                                updateResidentialCost(cost.id,'phasing',{type:'manual',values:nv});
                                                                                                            }}
                                                                                                            className={`w-12 px-1 py-0.5 border rounded text-center ${!validation.valid?'border-red-400 bg-red-50':'border-yellow-300'}`}
                                                                                                        />
                                                                                                    </td>
                                                                                                ))}
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                    {!validation.valid && <div className="text-red-500 text-xs mt-0.5">{validation.error} — must total 100%</div>}
                                                                                </div>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Delete */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {cost.canDelete && (
                                                                    <button onClick={() => deleteResidentialCost(cost.id)} className="text-red-500 hover:text-red-700 text-lg">🗑️</button>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Add Row Button */}
                                        <div className="mb-8">
                                            <button onClick={addResidentialCost}
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold">
                                                + Add Row
                                            </button>
                                        </div>

                                        {/* CAPEX Summary */}
                                        <h3 className="text-xl font-bold text-blue-800 mb-4">RESIDENTIAL CAPEX SUMMARY</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="bg-gray-700 text-white">
                                                        <th className="p-3 text-left" style={{minWidth:'160px'}}>Description</th>
                                                        <th className="p-3 text-right" style={{minWidth:'110px'}}>Total</th>
                                                        {Array.from({ length: constructionPeriods + 1 }, (_, i) => (
                                                            <th key={i} className="p-3 text-right whitespace-nowrap" style={{minWidth:'80px'}}>
                                                                {modelType === 'monthly' ? 'Month' : 'Year'} {i}
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {residentialCapex.items.map((item, idx) => (
                                                        <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                            <td className="p-2 font-medium">{item.name}</td>
                                                            <td className="p-2 text-right font-semibold">{formatNumber(item.total)}</td>
                                                            {item.distribution.map((amount, periodIdx) => (
                                                                <td key={periodIdx} className="p-2 text-right">
                                                                    {amount > 0 ? formatNumber(amount) : '-'}
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                    <tr className="total-row">
                                                        <td className="p-3 font-bold">TOTAL CAPEX</td>
                                                        <td className="p-3 text-right font-bold">{formatNumber(residentialCapex.totals.reduce((a,b)=>a+b,0))}</td>
                                                        {residentialCapex.totals.map((total, idx) => (
                                                            <td key={idx} className="p-3 text-right font-bold">
                                                                {total > 0 ? formatNumber(total) : '-'}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* HOSPITALITY DEVELOPMENT COSTS */}
                                {showHospitality && (
                                    <div className="module-card p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-green-800">HOSPITALITY DEVELOPMENT COSTS</h2>
                                            <span className="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">All figures in {currency}</span>
                                        </div>

                                        <div className="overflow-x-auto mb-4">
                                            <table className="w-full text-sm border-collapse" style={{minWidth:'1200px'}}>
                                                <thead>
                                                    <tr className="bg-gray-700 text-white text-xs">
                                                        <th className="p-2 text-left" style={{minWidth:'150px'}}>Cost Item Name</th>
                                                        <th className="p-2 text-left" style={{minWidth:'220px'}}>Calculation Method</th>
                                                        <th className="p-2 text-right" style={{minWidth:'120px'}}>Area / Base Value</th>
                                                        <th className="p-2 text-right" style={{minWidth:'90px'}}>Input Value</th>
                                                        <th className="p-2 text-right" style={{minWidth:'110px'}}>Total Cost</th>
                                                        <th className="p-2 text-center" style={{minWidth:'75px'}}>Start Period</th>
                                                        <th className="p-2 text-center" style={{minWidth:'75px'}}>End Period</th>
                                                        <th className="p-2 text-left" style={{minWidth:'200px'}}>Period Wise Allocation %</th>
                                                        <th className="p-2 text-center" style={{minWidth:'40px'}}></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                                                                {/* Row body */}
                                                {hospitalityCosts.map((cost, idx) => {
                                                    const isLand  = cost.id === 1;
                                                    const isRate  = cost.method.startsWith('rate_');
                                                    const isPct   = cost.method === 'percent_base';
                                                    const areaVal = isRate ? getMethodBase(cost.method, 'hospitality') : null;
                                                    const baseVal = isPct  ? getSelectedBase(cost, hospitalityCosts, 'hospitality') : null;
                                                    const total   = calculateItemTotal(cost, 'hospitality');
                                                    const otherCosts = hospitalityCosts.filter(c => c.id !== cost.id);
                                                    const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                                    const a = getAreas('hospitality');
                                                    return (
                                                        <tr key={cost.id} className={rowBg}>

                                                            {/* Cost Item Name */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                <input type="text" value={cost.name}
                                                                    onChange={e => updateHospitalityCost(cost.id, 'name', e.target.value)}
                                                                    disabled={isLand}
                                                                    className={`w-full px-2 py-1 border rounded text-xs ${isLand ? 'bg-gray-100 text-gray-500 border-gray-200 cursor-not-allowed' : 'border-yellow-300'}`}
                                                                />
                                                            </td>

                                                            {/* Calculation Method */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-400 italic">Fixed (Auto-calculated)</span>
                                                                ) : (
                                                                    <div>
                                                                        <select value={cost.method}
                                                                            onChange={e => updateHospitalityCost(cost.id, 'method', e.target.value)}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs mb-1">
                                                                            <optgroup label="── Fixed ──">
                                                                                <option value="fixed">Fixed Amount</option>
                                                                            </optgroup>
                                                                            <optgroup label="── Rate (×Area sqm) ──">
                                                                                <option value="rate_total_allocated">Total Allocated Area</option>
                                                                                <option value="rate_net_developable">Net Developable Area</option>
                                                                                <option value="rate_roads">Roads Area</option>
                                                                                <option value="rate_gfa">GFA</option>
                                                                                <option value="rate_bua">BUA</option>
                                                                            </optgroup>
                                                                            <optgroup label="── Percentage of ──">
                                                                                <option value="percent_base">% of Selected Costs ▾</option>
                                                                                <option value="percent_total_land">% of Total Land Cost</option>
                                                                                <option value="percent_cash_land">% of Cash Land Value</option>
                                                                                <option value="percent_inkind_land">% of In-Kind Land Value</option>
                                                                            </optgroup>
                                                                        </select>
                                                                        {isPct && (
                                                                            <div className="border border-blue-200 rounded bg-white shadow-sm" style={{maxHeight:'110px', overflowY:'auto', fontSize:'0.68rem'}}>
                                                                                {otherCosts.length === 0
                                                                                    ? <div className="text-gray-400 px-2 py-1 italic">No other items yet</div>
                                                                                    : otherCosts.map(oc => (
                                                                                        <label key={oc.id} className="flex items-center gap-1.5 px-2 py-0.5 hover:bg-blue-50 cursor-pointer">
                                                                                            <input type="checkbox"
                                                                                                checked={(cost.selectedIds||[]).includes(oc.id)}
                                                                                                onChange={e => {
                                                                                                    const sel = cost.selectedIds || [];
                                                                                                    updateHospitalityCost(cost.id, 'selectedIds',
                                                                                                        e.target.checked ? [...sel, oc.id] : sel.filter(x => x !== oc.id));
                                                                                                }}
                                                                                            />
                                                                                            <span className="text-gray-700">{oc.name}</span>
                                                                                        </label>
                                                                                    ))
                                                                                }
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Area / Base Value */}
                                                            <td className="p-2 border-b border-gray-200 text-right text-xs">
                                                                {isLand && <span className="text-gray-400 italic">—</span>}
                                                                {isRate && <span className="font-semibold text-blue-700">{formatInput(areaVal)} sqm</span>}
                                                                {isPct  && <span className="font-semibold text-purple-700">{formatNumber(baseVal)}</span>}
                                                                {cost.method === 'percent_total_land'  && <span className="font-semibold text-green-700">{formatNumber(a.landValue)}</span>}
                                                                {cost.method === 'percent_cash_land'   && <span className="font-semibold text-green-700">{formatNumber(a.cashLandValue)}</span>}
                                                                {cost.method === 'percent_inkind_land' && <span className="font-semibold text-green-700">{formatNumber(a.inKindLandValue)}</span>}
                                                                {cost.method === 'fixed' && !isLand && <span className="text-gray-400 italic">—</span>}
                                                            </td>

                                                            {/* Input Value */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-500 text-right block">{formatNumber(cost.value)}</span>
                                                                ) : (
                                                                    <div className="flex items-center gap-0.5 justify-end">
                                                                        {isPct || cost.method.startsWith('percent_') ? <span className="text-gray-500 text-xs">%</span> : isRate ? <span className="text-gray-500 text-xs">$/sqm</span> : null}
                                                                        <input type="number" value={cost.value}
                                                                            onChange={e => updateHospitalityCost(cost.id, 'value', parseFloat(e.target.value)||0)}
                                                                            className="w-20 px-2 py-1 border border-yellow-300 rounded text-xs text-right"
                                                                        />
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Total Cost */}
                                                            <td className="p-2 border-b border-gray-200 text-right font-bold text-green-900 text-sm">
                                                                {formatNumber(total)}
                                                            </td>

                                                            {/* Start Period */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {isLand ? <span className="text-xs text-gray-400">0</span> : (
                                                                    <input type="number" value={cost.startPeriod} min="0" max={constructionPeriods}
                                                                        onChange={e => updateHospitalityCost(cost.id, 'startPeriod', parseInt(e.target.value)||0)}
                                                                        className="w-14 px-1 py-1 border border-yellow-300 rounded text-xs text-center"/>
                                                                )}
                                                            </td>

                                                            {/* End Period */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {isLand ? <span className="text-xs text-gray-400">0</span> : (
                                                                    <input type="number" value={cost.endPeriod} min="0" max={constructionPeriods}
                                                                        onChange={e => updateHospitalityCost(cost.id, 'endPeriod', parseInt(e.target.value)||0)}
                                                                        className="w-14 px-1 py-1 border border-yellow-300 rounded text-xs text-center"/>
                                                                )}
                                                            </td>

                                                            {/* Period Wise Allocation % */}
                                                            <td className="p-2 border-b border-gray-200" style={{minWidth:'200px'}}>
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-400">100% (Period 0)</span>
                                                                ) : (
                                                                    <div>
                                                                        <select
                                                                            value={getPhasingMode(cost)}
                                                                            onChange={e => {
                                                                                const mode = e.target.value;
                                                                                if (mode === 'even') {
                                                                                    updateHospitalityCost(cost.id, 'phasing', 'even');
                                                                                } else {
                                                                                    const cnt = Math.max(1, cost.endPeriod - cost.startPeriod + 1);
                                                                                    updateHospitalityCost(cost.id, 'phasing', {type:'manual', values: Array(cnt).fill(0)});
                                                                                }
                                                                            }}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs mb-1"
                                                                        >
                                                                            <option value="even">Even Distribution</option>
                                                                            <option value="manual">Manual Allocation %</option>
                                                                        </select>
                                                                        {getPhasingMode(cost) === 'manual' && (() => {
                                                                            const cnt = Math.max(1, cost.endPeriod - cost.startPeriod + 1);
                                                                            const vals = getPhasingValues(cost);
                                                                            const filledVals = Array(cnt).fill(0).map((_, i) => vals[i] !== undefined ? vals[i] : 0);
                                                                            const validation = validatePhasingValues(filledVals, cost.startPeriod, cost.endPeriod);
                                                                            const totalPct = filledVals.reduce((a,b)=>a+b,0);
                                                                            return (
                                                                                <div className="border border-gray-200 rounded bg-gray-50 p-1" style={{overflowX:'auto'}}>
                                                                                    <table className="text-xs" style={{minWidth: Math.max(200, cnt*55)+'px'}}>
                                                                                        <thead>
                                                                                            <tr className="bg-gray-200">
                                                                                                <td className="px-1 py-0.5 font-semibold text-gray-600 whitespace-nowrap">Period</td>
                                                                                                <td className="px-1 py-0.5 font-semibold text-center text-gray-600 whitespace-nowrap">Total</td>
                                                                                                {filledVals.map((_, i) => (
                                                                                                    <td key={i} className="px-1 py-0.5 font-semibold text-center text-gray-600 whitespace-nowrap">
                                                                                                        {modelType==='monthly'?'M':'Y'}{cost.startPeriod+i}
                                                                                                    </td>
                                                                                                ))}
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            <tr>
                                                                                                <td className="px-1 py-0.5 text-gray-500 whitespace-nowrap">Alloc %</td>
                                                                                                <td className={`px-1 py-0.5 text-center font-bold whitespace-nowrap ${!validation.valid?'text-red-600':'text-green-700'}`}>
                                                                                                    {totalPct.toFixed(1)}%
                                                                                                </td>
                                                                                                {filledVals.map((v,i) => (
                                                                                                    <td key={i} className="px-0.5 py-0.5">
                                                                                                        <input type="number" value={v} min="0" max="100" step="0.1"
                                                                                                            onChange={e => {
                                                                                                                const nv=[...filledVals]; nv[i]=parseFloat(e.target.value)||0;
                                                                                                                updateHospitalityCost(cost.id,'phasing',{type:'manual',values:nv});
                                                                                                            }}
                                                                                                            className={`w-12 px-1 py-0.5 border rounded text-center ${!validation.valid?'border-red-400 bg-red-50':'border-yellow-300'}`}
                                                                                                        />
                                                                                                    </td>
                                                                                                ))}
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                    {!validation.valid && <div className="text-red-500 text-xs mt-0.5">{validation.error} — must total 100%</div>}
                                                                                </div>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Delete */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {cost.canDelete && (
                                                                    <button onClick={() => deleteHospitalityCost(cost.id)} className="text-red-500 hover:text-red-700 text-lg">🗑️</button>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div className="mb-8">
                                            <button onClick={addHospitalityCost}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-semibold">
                                                + Add Row
                                            </button>
                                        </div>

                                        <h3 className="text-xl font-bold text-green-800 mb-4">HOSPITALITY CAPEX SUMMARY</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="bg-gray-700 text-white">
                                                        <th className="p-3 text-left" style={{minWidth:'160px'}}>Description</th>
                                                        <th className="p-3 text-right" style={{minWidth:'110px'}}>Total</th>
                                                        {Array.from({ length: constructionPeriods + 1 }, (_, i) => (
                                                            <th key={i} className="p-3 text-right whitespace-nowrap" style={{minWidth:'80px'}}>
                                                                {modelType === 'monthly' ? 'Month' : 'Year'} {i}
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {hospitalityCapex.items.map((item, idx) => (
                                                        <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                            <td className="p-2 font-medium">{item.name}</td>
                                                            <td className="p-2 text-right font-semibold">{formatNumber(item.total)}</td>
                                                            {item.distribution.map((amount, periodIdx) => (
                                                                <td key={periodIdx} className="p-2 text-right">{amount > 0 ? formatNumber(amount) : '-'}</td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                    <tr className="total-row">
                                                        <td className="p-3 font-bold">TOTAL CAPEX</td>
                                                        <td className="p-3 text-right font-bold">{formatNumber(hospitalityCapex.totals.reduce((a,b)=>a+b,0))}</td>
                                                        {hospitalityCapex.totals.map((total, idx) => (
                                                            <td key={idx} className="p-3 text-right font-bold">{total > 0 ? formatNumber(total) : '-'}</td>
                                                        ))}
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}



                                {/* RETAIL DEVELOPMENT COSTS */}
                                {showRetail && (
                                    <div className="module-card p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-purple-800">RETAIL DEVELOPMENT COSTS</h2>
                                            <span className="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">All figures in {currency}</span>
                                        </div>

                                        <div className="overflow-x-auto mb-4">
                                            <table className="w-full text-sm border-collapse" style={{minWidth:'1200px'}}>
                                                <thead>
                                                    <tr className="bg-gray-700 text-white text-xs">
                                                        <th className="p-2 text-left" style={{minWidth:'150px'}}>Cost Item Name</th>
                                                        <th className="p-2 text-left" style={{minWidth:'220px'}}>Calculation Method</th>
                                                        <th className="p-2 text-right" style={{minWidth:'120px'}}>Area / Base Value</th>
                                                        <th className="p-2 text-right" style={{minWidth:'90px'}}>Input Value</th>
                                                        <th className="p-2 text-right" style={{minWidth:'110px'}}>Total Cost</th>
                                                        <th className="p-2 text-center" style={{minWidth:'75px'}}>Start Period</th>
                                                        <th className="p-2 text-center" style={{minWidth:'75px'}}>End Period</th>
                                                        <th className="p-2 text-left" style={{minWidth:'200px'}}>Period Wise Allocation %</th>
                                                        <th className="p-2 text-center" style={{minWidth:'40px'}}></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                                                                {/* Row body */}
                                                {retailCosts.map((cost, idx) => {
                                                    const isLand  = cost.id === 1;
                                                    const isRate  = cost.method.startsWith('rate_');
                                                    const isPct   = cost.method === 'percent_base';
                                                    const areaVal = isRate ? getMethodBase(cost.method, 'retail') : null;
                                                    const baseVal = isPct  ? getSelectedBase(cost, retailCosts, 'retail') : null;
                                                    const total   = calculateItemTotal(cost, 'retail');
                                                    const otherCosts = retailCosts.filter(c => c.id !== cost.id);
                                                    const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                                    const a = getAreas('retail');
                                                    return (
                                                        <tr key={cost.id} className={rowBg}>

                                                            {/* Cost Item Name */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                <input type="text" value={cost.name}
                                                                    onChange={e => updateRetailCost(cost.id, 'name', e.target.value)}
                                                                    disabled={isLand}
                                                                    className={`w-full px-2 py-1 border rounded text-xs ${isLand ? 'bg-gray-100 text-gray-500 border-gray-200 cursor-not-allowed' : 'border-yellow-300'}`}
                                                                />
                                                            </td>

                                                            {/* Calculation Method */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-400 italic">Fixed (Auto-calculated)</span>
                                                                ) : (
                                                                    <div>
                                                                        <select value={cost.method}
                                                                            onChange={e => updateRetailCost(cost.id, 'method', e.target.value)}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs mb-1">
                                                                            <optgroup label="── Fixed ──">
                                                                                <option value="fixed">Fixed Amount</option>
                                                                            </optgroup>
                                                                            <optgroup label="── Rate (×Area sqm) ──">
                                                                                <option value="rate_total_allocated">Total Allocated Area</option>
                                                                                <option value="rate_net_developable">Net Developable Area</option>
                                                                                <option value="rate_roads">Roads Area</option>
                                                                                <option value="rate_gfa">GFA</option>
                                                                                <option value="rate_bua">BUA</option>
                                                                            </optgroup>
                                                                            <optgroup label="── Percentage of ──">
                                                                                <option value="percent_base">% of Selected Costs ▾</option>
                                                                                <option value="percent_total_land">% of Total Land Cost</option>
                                                                                <option value="percent_cash_land">% of Cash Land Value</option>
                                                                                <option value="percent_inkind_land">% of In-Kind Land Value</option>
                                                                            </optgroup>
                                                                        </select>
                                                                        {isPct && (
                                                                            <div className="border border-blue-200 rounded bg-white shadow-sm" style={{maxHeight:'110px', overflowY:'auto', fontSize:'0.68rem'}}>
                                                                                {otherCosts.length === 0
                                                                                    ? <div className="text-gray-400 px-2 py-1 italic">No other items yet</div>
                                                                                    : otherCosts.map(oc => (
                                                                                        <label key={oc.id} className="flex items-center gap-1.5 px-2 py-0.5 hover:bg-blue-50 cursor-pointer">
                                                                                            <input type="checkbox"
                                                                                                checked={(cost.selectedIds||[]).includes(oc.id)}
                                                                                                onChange={e => {
                                                                                                    const sel = cost.selectedIds || [];
                                                                                                    updateRetailCost(cost.id, 'selectedIds',
                                                                                                        e.target.checked ? [...sel, oc.id] : sel.filter(x => x !== oc.id));
                                                                                                }}
                                                                                            />
                                                                                            <span className="text-gray-700">{oc.name}</span>
                                                                                        </label>
                                                                                    ))
                                                                                }
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Area / Base Value */}
                                                            <td className="p-2 border-b border-gray-200 text-right text-xs">
                                                                {isLand && <span className="text-gray-400 italic">—</span>}
                                                                {isRate && <span className="font-semibold text-blue-700">{formatInput(areaVal)} sqm</span>}
                                                                {isPct  && <span className="font-semibold text-purple-700">{formatNumber(baseVal)}</span>}
                                                                {cost.method === 'percent_total_land'  && <span className="font-semibold text-green-700">{formatNumber(a.landValue)}</span>}
                                                                {cost.method === 'percent_cash_land'   && <span className="font-semibold text-green-700">{formatNumber(a.cashLandValue)}</span>}
                                                                {cost.method === 'percent_inkind_land' && <span className="font-semibold text-green-700">{formatNumber(a.inKindLandValue)}</span>}
                                                                {cost.method === 'fixed' && !isLand && <span className="text-gray-400 italic">—</span>}
                                                            </td>

                                                            {/* Input Value */}
                                                            <td className="p-2 border-b border-gray-200">
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-500 text-right block">{formatNumber(cost.value)}</span>
                                                                ) : (
                                                                    <div className="flex items-center gap-0.5 justify-end">
                                                                        {isPct || cost.method.startsWith('percent_') ? <span className="text-gray-500 text-xs">%</span> : isRate ? <span className="text-gray-500 text-xs">$/sqm</span> : null}
                                                                        <input type="number" value={cost.value}
                                                                            onChange={e => updateRetailCost(cost.id, 'value', parseFloat(e.target.value)||0)}
                                                                            className="w-20 px-2 py-1 border border-yellow-300 rounded text-xs text-right"
                                                                        />
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Total Cost */}
                                                            <td className="p-2 border-b border-gray-200 text-right font-bold text-purple-900 text-sm">
                                                                {formatNumber(total)}
                                                            </td>

                                                            {/* Start Period */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {isLand ? <span className="text-xs text-gray-400">0</span> : (
                                                                    <input type="number" value={cost.startPeriod} min="0" max={constructionPeriods}
                                                                        onChange={e => updateRetailCost(cost.id, 'startPeriod', parseInt(e.target.value)||0)}
                                                                        className="w-14 px-1 py-1 border border-yellow-300 rounded text-xs text-center"/>
                                                                )}
                                                            </td>

                                                            {/* End Period */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {isLand ? <span className="text-xs text-gray-400">0</span> : (
                                                                    <input type="number" value={cost.endPeriod} min="0" max={constructionPeriods}
                                                                        onChange={e => updateRetailCost(cost.id, 'endPeriod', parseInt(e.target.value)||0)}
                                                                        className="w-14 px-1 py-1 border border-yellow-300 rounded text-xs text-center"/>
                                                                )}
                                                            </td>

                                                            {/* Period Wise Allocation % */}
                                                            <td className="p-2 border-b border-gray-200" style={{minWidth:'200px'}}>
                                                                {isLand ? (
                                                                    <span className="text-xs text-gray-400">100% (Period 0)</span>
                                                                ) : (
                                                                    <div>
                                                                        <select
                                                                            value={getPhasingMode(cost)}
                                                                            onChange={e => {
                                                                                const mode = e.target.value;
                                                                                if (mode === 'even') {
                                                                                    updateRetailCost(cost.id, 'phasing', 'even');
                                                                                } else {
                                                                                    const cnt = Math.max(1, cost.endPeriod - cost.startPeriod + 1);
                                                                                    updateRetailCost(cost.id, 'phasing', {type:'manual', values: Array(cnt).fill(0)});
                                                                                }
                                                                            }}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs mb-1"
                                                                        >
                                                                            <option value="even">Even Distribution</option>
                                                                            <option value="manual">Manual Allocation %</option>
                                                                        </select>
                                                                        {getPhasingMode(cost) === 'manual' && (() => {
                                                                            const cnt = Math.max(1, cost.endPeriod - cost.startPeriod + 1);
                                                                            const vals = getPhasingValues(cost);
                                                                            const filledVals = Array(cnt).fill(0).map((_, i) => vals[i] !== undefined ? vals[i] : 0);
                                                                            const validation = validatePhasingValues(filledVals, cost.startPeriod, cost.endPeriod);
                                                                            const totalPct = filledVals.reduce((a,b)=>a+b,0);
                                                                            return (
                                                                                <div className="border border-gray-200 rounded bg-gray-50 p-1" style={{overflowX:'auto'}}>
                                                                                    <table className="text-xs" style={{minWidth: Math.max(200, cnt*55)+'px'}}>
                                                                                        <thead>
                                                                                            <tr className="bg-gray-200">
                                                                                                <td className="px-1 py-0.5 font-semibold text-gray-600 whitespace-nowrap">Period</td>
                                                                                                <td className="px-1 py-0.5 font-semibold text-center text-gray-600 whitespace-nowrap">Total</td>
                                                                                                {filledVals.map((_, i) => (
                                                                                                    <td key={i} className="px-1 py-0.5 font-semibold text-center text-gray-600 whitespace-nowrap">
                                                                                                        {modelType==='monthly'?'M':'Y'}{cost.startPeriod+i}
                                                                                                    </td>
                                                                                                ))}
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            <tr>
                                                                                                <td className="px-1 py-0.5 text-gray-500 whitespace-nowrap">Alloc %</td>
                                                                                                <td className={`px-1 py-0.5 text-center font-bold whitespace-nowrap ${!validation.valid?'text-red-600':'text-green-700'}`}>
                                                                                                    {totalPct.toFixed(1)}%
                                                                                                </td>
                                                                                                {filledVals.map((v,i) => (
                                                                                                    <td key={i} className="px-0.5 py-0.5">
                                                                                                        <input type="number" value={v} min="0" max="100" step="0.1"
                                                                                                            onChange={e => {
                                                                                                                const nv=[...filledVals]; nv[i]=parseFloat(e.target.value)||0;
                                                                                                                updateRetailCost(cost.id,'phasing',{type:'manual',values:nv});
                                                                                                            }}
                                                                                                            className={`w-12 px-1 py-0.5 border rounded text-center ${!validation.valid?'border-red-400 bg-red-50':'border-yellow-300'}`}
                                                                                                        />
                                                                                                    </td>
                                                                                                ))}
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                    {!validation.valid && <div className="text-red-500 text-xs mt-0.5">{validation.error} — must total 100%</div>}
                                                                                </div>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Delete */}
                                                            <td className="p-2 border-b border-gray-200 text-center">
                                                                {cost.canDelete && (
                                                                    <button onClick={() => deleteRetailCost(cost.id)} className="text-red-500 hover:text-red-700 text-lg">🗑️</button>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div className="mb-8">
                                            <button onClick={addRetailCost}
                                                className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded text-sm font-semibold">
                                                + Add Row
                                            </button>
                                        </div>

                                        <h3 className="text-xl font-bold text-purple-800 mb-4">RETAIL CAPEX SUMMARY</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="bg-gray-700 text-white">
                                                        <th className="p-3 text-left" style={{minWidth:'160px'}}>Description</th>
                                                        <th className="p-3 text-right" style={{minWidth:'110px'}}>Total</th>
                                                        {Array.from({ length: constructionPeriods + 1 }, (_, i) => (
                                                            <th key={i} className="p-3 text-right whitespace-nowrap" style={{minWidth:'80px'}}>
                                                                {modelType === 'monthly' ? 'Month' : 'Year'} {i}
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {retailCapex.items.map((item, idx) => (
                                                        <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                            <td className="p-2 font-medium">{item.name}</td>
                                                            <td className="p-2 text-right font-semibold">{formatNumber(item.total)}</td>
                                                            {item.distribution.map((amount, periodIdx) => (
                                                                <td key={periodIdx} className="p-2 text-right">{amount > 0 ? formatNumber(amount) : '-'}</td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                    <tr className="total-row">
                                                        <td className="p-3 font-bold">TOTAL CAPEX</td>
                                                        <td className="p-3 text-right font-bold">{formatNumber(retailCapex.totals.reduce((a,b)=>a+b,0))}</td>
                                                        {retailCapex.totals.map((total, idx) => (
                                                            <td key={idx} className="p-3 text-right font-bold">{total > 0 ? formatNumber(total) : '-'}</td>
                                                        ))}
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}                                </div>
                            )}

                            {/* Financing Tab */}
                                {activeTab === 'financing' && (
                                    <div className="module-card p-6">
                                        <h3 className="text-2xl font-bold mb-6 text-gray-800">Financing Structure - Summary</h3>
                                        
                                        <div className="mb-6 p-4 bg-gray-100 rounded-lg">
                                            <h4 className="font-bold mb-3">Debt & Equity Settings</h4>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium mb-2">Interest Rate (%)</label>
                                                    <input
                                                        type="number"
                                                        value={interestRate}
                                                        onChange={(e) => setInterestRate(parseFloat(e.target.value) || 0)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                                        step="0.1"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium mb-2">Debt %</label>
                                                    <div className="px-3 py-2 bg-white border border-gray-300 rounded font-bold">60%</div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium mb-2">Equity %</label>
                                                    <div className="px-3 py-2 bg-white border border-gray-300 rounded font-bold">40%</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-6">
                                            {/* Residential Financing */}
                                            <div className="p-4 bg-blue-50 rounded-lg">
                                                <h4 className="font-bold text-lg mb-3">Residential</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Description</th>
                                                                <th className="p-2 text-right">Total</th>
                                                                <th className="p-2 text-right">Equity (40%)</th>
                                                                <th className="p-2 text-right">Debt (60%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Land</td>
                                                                <td className="p-2 border text-right">${formatNumber(residentialLandValue * (cashPercent / 100))}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((residentialLandValue * (cashPercent / 100)) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((residentialLandValue * (cashPercent / 100)) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-gray-50">
                                                                <td className="p-2 border">Infrastructure</td>
                                                                <td className="p-2 border text-right">${formatNumber(residentialNetArea * 500)}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((residentialNetArea * 500) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((residentialNetArea * 500) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Construction</td>
                                                                <td className="p-2 border text-right">${formatNumber(residentialBUA * 1500)}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((residentialBUA * 1500) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((residentialBUA * 1500) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-blue-600 text-white font-bold">
                                                                <td className="p-3">TOTAL</td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber((residentialLandValue * (cashPercent / 100)) + (residentialNetArea * 500) + (residentialBUA * 1500))}
                                                                </td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber(((residentialLandValue * (cashPercent / 100)) + (residentialNetArea * 500) + (residentialBUA * 1500)) * 0.4)}
                                                                </td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber(((residentialLandValue * (cashPercent / 100)) + (residentialNetArea * 500) + (residentialBUA * 1500)) * 0.6)}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            {/* Hospitality Financing */}
                                            <div className="p-4 bg-green-50 rounded-lg">
                                                <h4 className="font-bold text-lg mb-3">Hospitality</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Description</th>
                                                                <th className="p-2 text-right">Total</th>
                                                                <th className="p-2 text-right">Equity (40%)</th>
                                                                <th className="p-2 text-right">Debt (60%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Land</td>
                                                                <td className="p-2 border text-right">${formatNumber(hospitalityLandValue * (cashPercent / 100))}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((hospitalityLandValue * (cashPercent / 100)) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((hospitalityLandValue * (cashPercent / 100)) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-gray-50">
                                                                <td className="p-2 border">Infrastructure</td>
                                                                <td className="p-2 border text-right">${formatNumber(hospitalityNetArea * 500)}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((hospitalityNetArea * 500) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((hospitalityNetArea * 500) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Construction</td>
                                                                <td className="p-2 border text-right">${formatNumber(hospitalityBUA * 1500)}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((hospitalityBUA * 1500) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((hospitalityBUA * 1500) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-green-600 text-white font-bold">
                                                                <td className="p-3">TOTAL</td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber((hospitalityLandValue * (cashPercent / 100)) + (hospitalityNetArea * 500) + (hospitalityBUA * 1500))}
                                                                </td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber(((hospitalityLandValue * (cashPercent / 100)) + (hospitalityNetArea * 500) + (hospitalityBUA * 1500)) * 0.4)}
                                                                </td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber(((hospitalityLandValue * (cashPercent / 100)) + (hospitalityNetArea * 500) + (hospitalityBUA * 1500)) * 0.6)}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            {/* Retail Financing */}
                                            <div className="p-4 bg-purple-50 rounded-lg">
                                                <h4 className="font-bold text-lg mb-3">Retail</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Description</th>
                                                                <th className="p-2 text-right">Total</th>
                                                                <th className="p-2 text-right">Equity (40%)</th>
                                                                <th className="p-2 text-right">Debt (60%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Land</td>
                                                                <td className="p-2 border text-right">${formatNumber(retailLandValue * (cashPercent / 100))}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((retailLandValue * (cashPercent / 100)) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((retailLandValue * (cashPercent / 100)) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-gray-50">
                                                                <td className="p-2 border">Infrastructure</td>
                                                                <td className="p-2 border text-right">${formatNumber(retailNetArea * 500)}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((retailNetArea * 500) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((retailNetArea * 500) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Construction</td>
                                                                <td className="p-2 border text-right">${formatNumber(retailBUA * 1500)}</td>
                                                                <td className="p-2 border text-right text-green-600 font-semibold">
                                                                    ${formatNumber((retailBUA * 1500) * 0.4)}
                                                                </td>
                                                                <td className="p-2 border text-right text-red-600 font-semibold">
                                                                    ${formatNumber((retailBUA * 1500) * 0.6)}
                                                                </td>
                                                            </tr>
                                                            <tr className="bg-purple-600 text-white font-bold">
                                                                <td className="p-3">TOTAL</td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber((retailLandValue * (cashPercent / 100)) + (retailNetArea * 500) + (retailBUA * 1500))}
                                                                </td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber(((retailLandValue * (cashPercent / 100)) + (retailNetArea * 500) + (retailBUA * 1500)) * 0.4)}
                                                                </td>
                                                                <td className="p-3 text-right">
                                                                    ${formatNumber(((retailLandValue * (cashPercent / 100)) + (retailNetArea * 500) + (retailBUA * 1500)) * 0.6)}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}


                </div>
            );
        }

        ReactDOM.render(<RealEstatePlatform />, document.getElementById('root'));
    </script>
</body>
</html>
