<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Financial Modeling Platform - Module 1 Complete</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .module-card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.07); 
            transition: all 0.3s; 
        }
        .module-card:hover { 
            box-shadow: 0 10px 20px rgba(0,0,0,0.12); 
            transform: translateY(-2px); 
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        input[type="number"], input[type="text"], input[type="date"], select { 
            transition: all 0.2s; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            transition: all 0.3s; 
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); 
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.875rem;
        }
        th {
            position: sticky;
            top: 0;
            background: #1f2937;
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #374151;
        }
        td {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: right;
        }
        td:first-child {
            text-align: left;
            font-weight: 500;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }
        .total-row {
            background: #e0e7ff;
            font-weight: 700;
        }
        .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Yellow input styling for assumptions */
        .input-assumption {
            background-color: #fef3c7 !important;
            color: #1e40af !important;
            font-weight: 600;
            border: 1px solid #fbbf24 !important;
        }
        .editable-label {
            background-color: #fef3c7;
            color: #1e40af;
            font-weight: 600;
            border: 1px solid #fbbf24;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function RealEstatePlatform() {
            // State Management
            const [activeModule, setActiveModule] = useState('overview');
            const [activeTab, setActiveTab] = useState('timeline');
            
            // Timeline
            const [projectName, setProjectName] = useState('Skyline');
            const [projectType, setProjectType] = useState('mixed-use');
            const [country, setCountry] = useState('United States');
            const [currency, setCurrency] = useState('USD');
            const [modelType, setModelType] = useState('monthly');
            const [projectStart, setProjectStart] = useState('2025-01-01');
            const [constructionPeriods, setConstructionPeriods] = useState(24);
            const [operationsPeriods, setOperationsPeriods] = useState(60);
            
            // Handle model type change with auto-conversion
            const handleModelTypeChange = (newType) => {
                if (modelType === 'monthly' && newType === 'annual') {
                    // Convert from monthly to annual
                    setConstructionPeriods(Math.round(constructionPeriods / 12));
                    setOperationsPeriods(Math.round(operationsPeriods / 12));
                } else if (modelType === 'annual' && newType === 'monthly') {
                    // Convert from annual to monthly
                    setConstructionPeriods(constructionPeriods * 12);
                    setOperationsPeriods(operationsPeriods * 12);
                }
                setModelType(newType);
            };
            
            // Land & Area
            const [cashPercent, setCashPercent] = useState(60);
            const [inKindPercent, setInKindPercent] = useState(40);
            const [totalLandArea, setTotalLandArea] = useState(100000);
            const [landValuePerSqm, setLandValuePerSqm] = useState(500);
            
            const [residentialPercent, setResidentialPercent] = useState(50);
            const [hospitalityPercent, setHospitalityPercent] = useState(30);
            const [retailPercent, setRetailPercent] = useState(20);
            
            const [residentialRoadsPercent, setResidentialRoadsPercent] = useState(20);
            const [hospitalityRoadsPercent, setHospitalityRoadsPercent] = useState(15);
            const [retailRoadsPercent, setRetailRoadsPercent] = useState(10);
            
            const [residentialFAR, setResidentialFAR] = useState(1.5);
            const [residentialEfficiency, setResidentialEfficiency] = useState(0.85);
            const [residentialGFABase, setResidentialGFABase] = useState('netDevelopable');
            const [residentialBUABase, setResidentialBUABase] = useState('gfa');
            const [residentialCustomRows, setResidentialCustomRows] = useState([]);
            
            const [hospitalityFAR, setHospitalityFAR] = useState(1.2);
            const [hospitalityEfficiency, setHospitalityEfficiency] = useState(0.80);
            const [hospitalityGFABase, setHospitalityGFABase] = useState('netDevelopable');
            const [hospitalityBUABase, setHospitalityBUABase] = useState('gfa');
            const [hospitalityCustomRows, setHospitalityCustomRows] = useState([]);
            
            const [retailFAR, setRetailFAR] = useState(1.0);
            const [retailEfficiency, setRetailEfficiency] = useState(0.90);
            const [retailGFABase, setRetailGFABase] = useState('netDevelopable');
            const [retailBUABase, setRetailBUABase] = useState('gfa');
            const [retailCustomRows, setRetailCustomRows] = useState([]);
            
            // Custom area metrics for each asset (editable/addable/deletable)
            const [residentialMetrics, setResidentialMetrics] = useState([
                { id: 1, name: 'Net Developable Area', type: 'calculated', formula: 'totalArea - roadsArea', isLocked: true },
                { id: 2, name: 'FAR', type: 'input', value: 1.5, isLocked: false },
                { id: 3, name: 'GFA', type: 'calculated', formula: 'netArea × FAR', isLocked: false, baseArea: 'netDevelopable' },
                { id: 4, name: 'Efficiency %', type: 'input', value: 85, isLocked: false },
                { id: 5, name: 'BUA', type: 'calculated', formula: 'GFA × Efficiency%', isLocked: false, baseArea: 'gfa' }
            ]);
            const [hospitalityMetrics, setHospitalityMetrics] = useState([
                { id: 1, name: 'Net Developable Area', type: 'calculated', formula: 'totalArea - roadsArea', isLocked: true },
                { id: 2, name: 'FAR', type: 'input', value: 1.2, isLocked: false },
                { id: 3, name: 'GFA', type: 'calculated', formula: 'netArea × FAR', isLocked: false, baseArea: 'netDevelopable' },
                { id: 4, name: 'Efficiency %', type: 'input', value: 80, isLocked: false },
                { id: 5, name: 'BUA', type: 'calculated', formula: 'GFA × Efficiency%', isLocked: false, baseArea: 'gfa' }
            ]);
            const [retailMetrics, setRetailMetrics] = useState([
                { id: 1, name: 'Net Developable Area', type: 'calculated', formula: 'totalArea - roadsArea', isLocked: true },
                { id: 2, name: 'FAR', type: 'input', value: 1.0, isLocked: false },
                { id: 3, name: 'GFA', type: 'calculated', formula: 'netArea × FAR', isLocked: false, baseArea: 'netDevelopable' },
                { id: 4, name: 'Efficiency %', type: 'input', value: 90, isLocked: false },
                { id: 5, name: 'BUA', type: 'calculated', formula: 'GFA × Efficiency%', isLocked: false, baseArea: 'gfa' }
            ]);
            
            // Functions to manage dynamic rows
            const addMetricRow = (assetType, setMetrics, metrics) => {
                const newId = Math.max(...metrics.map(m => m.id)) + 1;
                const newMetric = {
                    id: newId,
                    name: 'Custom Metric',
                    type: 'input',
                    value: 0,
                    isLocked: false,
                    baseArea: 'netDevelopable'
                };
                setMetrics([...metrics, newMetric]);
            };
            
            const deleteMetricRow = (metricId, setMetrics, metrics) => {
                setMetrics(metrics.filter(m => m.id !== metricId));
            };
            
            const updateMetricBaseArea = (metricId, newBaseArea, setMetrics, metrics) => {
                setMetrics(metrics.map(m => 
                    m.id === metricId ? { ...m, baseArea: newBaseArea } : m
                ));
            };
            
            // Land value calculations (used in Land & Area tab)
            const totalLandValue = totalLandArea * landValuePerSqm;
            const cashValue = (totalLandValue * cashPercent) / 100;
            const inKindValue = (totalLandValue * inKindPercent) / 100;

            // Project end date calculation
            const calculateProjectEndDate = () => {
                const startDate = new Date(projectStart);
                const totalMonths = modelType === 'monthly' 
                    ? constructionPeriods + operationsPeriods 
                    : (constructionPeriods + operationsPeriods) * 12;
                
                // Add months and subtract 1 day to get end of last month
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + totalMonths);
                endDate.setDate(0); // Last day of previous month
                
                return endDate.toISOString().split('T')[0];
            };
            
            const projectEndDate = calculateProjectEndDate();
            const totalProjectYears = modelType === 'monthly' 
                ? ((constructionPeriods + operationsPeriods) / 12).toFixed(1)
                : (constructionPeriods + operationsPeriods);
            
            // Determine which assets to show based on project type
            const showResidential = projectType === 'residential' || projectType === 'mixed-use';
            const showHospitality = projectType === 'hospitality' || projectType === 'mixed-use';
            const showRetail = true; // Always show retail
            
            // Area allocation validation - only count visible assets
            const totalAreaPercent = (showResidential ? residentialPercent : 0) + 
                                    (showHospitality ? hospitalityPercent : 0) + 
                                    retailPercent;
            const areaAllocationValid = Math.abs(totalAreaPercent - 100) < 0.01;
            
            // Residential
            const residentialTotalArea = (totalLandArea * residentialPercent) / 100;
            const residentialRoadsArea = (residentialTotalArea * residentialRoadsPercent) / 100;
            const residentialNetArea = residentialTotalArea - residentialRoadsArea;
            
            // GFA calculation based on selected base area
            const residentialGFABaseValue = residentialGFABase === 'totalAllocated' ? residentialTotalArea : residentialNetArea;
            const residentialGFA = residentialGFABaseValue * residentialFAR;
            
            // BUA calculation based on selected base area
            let residentialBUABaseValue;
            if (residentialBUABase === 'gfa') {
                residentialBUABaseValue = residentialGFA;
            } else if (residentialBUABase === 'netDevelopable') {
                residentialBUABaseValue = residentialNetArea;
            } else {
                residentialBUABaseValue = residentialTotalArea;
            }
            const residentialBUA = residentialBUABaseValue * residentialEfficiency;
            
            // Hospitality
            const hospitalityTotalArea = (totalLandArea * hospitalityPercent) / 100;
            const hospitalityRoadsArea = (hospitalityTotalArea * hospitalityRoadsPercent) / 100;
            const hospitalityNetArea = hospitalityTotalArea - hospitalityRoadsArea;
            
            // GFA calculation based on selected base area
            const hospitalityGFABaseValue = hospitalityGFABase === 'totalAllocated' ? hospitalityTotalArea : hospitalityNetArea;
            const hospitalityGFA = hospitalityGFABaseValue * hospitalityFAR;
            
            // BUA calculation based on selected base area
            let hospitalityBUABaseValue;
            if (hospitalityBUABase === 'gfa') {
                hospitalityBUABaseValue = hospitalityGFA;
            } else if (hospitalityBUABase === 'netDevelopable') {
                hospitalityBUABaseValue = hospitalityNetArea;
            } else {
                hospitalityBUABaseValue = hospitalityTotalArea;
            }
            const hospitalityBUA = hospitalityBUABaseValue * hospitalityEfficiency;
            
            // Retail
            const retailTotalArea = (totalLandArea * retailPercent) / 100;
            const retailRoadsArea = (retailTotalArea * retailRoadsPercent) / 100;
            const retailNetArea = retailTotalArea - retailRoadsArea;
            
            // GFA calculation based on selected base area
            const retailGFABaseValue = retailGFABase === 'totalAllocated' ? retailTotalArea : retailNetArea;
            const retailGFA = retailGFABaseValue * retailFAR;
            
            // BUA calculation based on selected base area
            let retailBUABaseValue;
            if (retailBUABase === 'gfa') {
                retailBUABaseValue = retailGFA;
            } else if (retailBUABase === 'netDevelopable') {
                retailBUABaseValue = retailNetArea;
            } else {
                retailBUABaseValue = retailTotalArea;
            }
            const retailBUA = retailBUABaseValue * retailEfficiency;
            
            const formatNumber = (num) => {
                if (!num || num === 0) return '0';
                return Math.round(num).toLocaleString('en-US');
            };
            
            const formatCurrency = (num) => {
                if (!num || num === 0) return currency + ' 0';
                return currency + ' ' + Math.round(num).toLocaleString('en-US');
            };
            
            // Helper function to get base area name for display
            const getBaseAreaName = (baseAreaKey) => {
                const nameMap = {
                    'totalAllocated': 'Total Allocated Area',
                    'netDevelopable': 'Net Developable Area',
                    'gfa': 'GFA'
                };
                return nameMap[baseAreaKey] || baseAreaKey;
            };
            
            // Helper function to get base area value
            const getBaseAreaValue = (baseAreaKey, totalArea, netArea, gfaArea) => {
                if (baseAreaKey === 'totalAllocated') return totalArea;
                if (baseAreaKey === 'netDevelopable') return netArea;
                if (baseAreaKey === 'gfa') return gfaArea;
                return netArea;
            };
            
            // Add custom row function
            const addCustomRow = (sectionType) => {
                const newRow = {
                    id: Date.now(),
                    name: 'Custom Metric',
                    value: 0,
                    baseArea: 'netDevelopable',
                    multiplier: 1.0
                };
                
                if (sectionType === 'residential') {
                    setResidentialCustomRows([...residentialCustomRows, newRow]);
                } else if (sectionType === 'hospitality') {
                    setHospitalityCustomRows([...hospitalityCustomRows, newRow]);
                } else if (sectionType === 'retail') {
                    setRetailCustomRows([...retailCustomRows, newRow]);
                }
            };
            
            // Delete custom row function
            const deleteCustomRow = (sectionType, rowId) => {
                if (sectionType === 'residential') {
                    setResidentialCustomRows(residentialCustomRows.filter(row => row.id !== rowId));
                } else if (sectionType === 'hospitality') {
                    setHospitalityCustomRows(hospitalityCustomRows.filter(row => row.id !== rowId));
                } else if (sectionType === 'retail') {
                    setRetailCustomRows(retailCustomRows.filter(row => row.id !== rowId));
                }
            };
            
            // Update custom row
            const updateCustomRow = (sectionType, rowId, field, value) => {
                const updateRows = (rows) => rows.map(row => 
                    row.id === rowId ? { ...row, [field]: value } : row
                );
                
                if (sectionType === 'residential') {
                    setResidentialCustomRows(updateRows(residentialCustomRows));
                } else if (sectionType === 'hospitality') {
                    setHospitalityCustomRows(updateRows(hospitalityCustomRows));
                } else if (sectionType === 'retail') {
                    setRetailCustomRows(updateRows(retailCustomRows));
                }
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <div className="gradient-bg text-white p-6 shadow-lg">
                        <h1 className="text-3xl font-bold">Real Estate Financial Modeling Platform</h1>
                        <p className="text-sm opacity-90 mt-1">Module 1: Project Setup & Financial Structure</p>
                    </div>

                    {/* Navigation */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="container mx-auto px-6">
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setActiveModule('overview')}
                                    className={`px-6 py-4 font-semibold transition ${
                                        activeModule === 'overview' ? 'tab-active' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Overview
                                </button>
                                <button
                                    onClick={() => setActiveModule('module1')}
                                    className={`px-6 py-4 font-semibold transition ${
                                        activeModule === 'module1' ? 'tab-active' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Module 1
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Module 1 Content */}
                    {activeModule === 'overview' && (
                        <div className="container mx-auto px-6 py-6">
                            {/* Project Overview Dashboard */}
                            <div className="module-card p-8 mb-6">
                                <h2 className="text-3xl font-bold mb-6 text-gray-800">Project Overview</h2>
                                
                                <div className="grid grid-cols-3 gap-6 mb-8">
                                    <div className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                                        <div className="text-sm text-blue-600 font-medium mb-2">Project Name</div>
                                        <div className="text-2xl font-bold text-gray-800">{projectName}</div>
                                        <div className="text-sm text-gray-600 mt-1">{projectType.charAt(0).toUpperCase() + projectType.slice(1)}</div>
                                    </div>
                                    
                                    <div className="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                                        <div className="text-sm text-green-600 font-medium mb-2">Total Land Area</div>
                                        <div className="text-2xl font-bold text-gray-800">{formatNumber(totalLandArea)} sqm</div>
                                        <div className="text-sm text-gray-600 mt-1">Value: ${formatNumber(totalLandValue)}</div>
                                    </div>
                                    
                                    <div className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                                        <div className="text-sm text-purple-600 font-medium mb-2">Project Duration</div>
                                        <div className="text-2xl font-bold text-gray-800">
                                            {constructionPeriods + operationsPeriods} {modelType === 'monthly' ? 'Months' : 'Years'}
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            Construction: {constructionPeriods} | Operations: {operationsPeriods}
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-700 mb-4">Land Acquisition</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between p-3 bg-green-50 rounded">
                                                <span className="text-gray-700">Cash Purchase ({cashPercent}%)</span>
                                                <span className="font-bold text-green-700">${formatNumber(cashValue)}</span>
                                            </div>
                                            <div className="flex justify-between p-3 bg-blue-50 rounded">
                                                <span className="text-gray-700">In-Kind Contribution ({inKindPercent}%)</span>
                                                <span className="font-bold text-blue-700">${formatNumber(inKindValue)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-700 mb-4">Area Allocation</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between p-3 bg-blue-50 rounded">
                                                <span className="text-gray-700">Residential ({residentialPercent}%)</span>
                                                <span className="font-bold text-blue-700">{formatNumber(residentialTotalArea)} sqm</span>
                                            </div>
                                            <div className="flex justify-between p-3 bg-green-50 rounded">
                                                <span className="text-gray-700">Hospitality ({hospitalityPercent}%)</span>
                                                <span className="font-bold text-green-700">{formatNumber(hospitalityTotalArea)} sqm</span>
                                            </div>
                                            <div className="flex justify-between p-3 bg-purple-50 rounded">
                                                <span className="text-gray-700">Retail ({retailPercent}%)</span>
                                                <span className="font-bold text-purple-700">{formatNumber(retailTotalArea)} sqm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Module Navigation Cards */}
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">Financial Modeling Modules</h2>
                            <div className="grid grid-cols-3 gap-6">
                                {/* Module 1 - Active */}
                                <div className="module-card p-6 cursor-pointer border-2 border-purple-500" onClick={() => {
                                    setActiveModule('module1');
                                    setActiveTab('timeline');
                                }}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 1</h3>
                                        <span className="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">ACTIVE</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Project Setup & Financial Structure</p>
                                    <ul className="text-sm text-gray-600 space-y-2">
                                        <li>✓ Project Details & Timeline</li>
                                        <li>✓ Land & Area Allocation</li>
                                    </ul>
                                    <button className="mt-4 w-full btn-primary text-white px-4 py-2 rounded-lg font-medium">
                                        Open Module
                                    </button>
                                </div>

                                {/* Module 2 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 2</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Revenue & Sales Projections</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• Unit Mix & Pricing</li>
                                        <li>• Sales Schedule</li>
                                        <li>• Revenue Recognition</li>
                                        <li>• Hospitality Revenue</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 3 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 3</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Operating Expenses & Cash Flow</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• OPEX Schedule</li>
                                        <li>• Property Management</li>
                                        <li>• Cash Flow Analysis</li>
                                        <li>• Working Capital</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 4 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 4</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Returns & Valuation Analysis</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• IRR Calculation</li>
                                        <li>• NPV Analysis</li>
                                        <li>• Exit Valuation</li>
                                        <li>• Sensitivity Analysis</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 5 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 5</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Financial Statements</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• Income Statement</li>
                                        <li>• Balance Sheet</li>
                                        <li>• Cash Flow Statement</li>
                                        <li>• Financial Ratios</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>

                                {/* Module 6 - Coming Soon */}
                                <div className="module-card p-6 opacity-60 cursor-not-allowed">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold text-gray-800">Module 6</h3>
                                        <span className="px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full">COMING SOON</span>
                                    </div>
                                    <p className="text-gray-600 mb-4">Reports & Visualizations</p>
                                    <ul className="text-sm text-gray-500 space-y-2">
                                        <li>• Executive Summary</li>
                                        <li>• Charts & Graphs</li>
                                        <li>• Export to PDF/Excel</li>
                                        <li>• Investor Presentations</li>
                                    </ul>
                                    <button className="mt-4 w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-medium cursor-not-allowed">
                                        Coming Soon
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Module 1 Detailed View */}
                    {activeModule === 'module1' && (
                        <div className="container mx-auto px-6 py-6">
                            {/* Sub Navigation */}
                            <div className="sticky-nav bg-white rounded-lg shadow-sm p-2 mb-6 flex gap-2">
                                <button
                                    onClick={() => setActiveTab('timeline')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'timeline' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Project Details & Timeline
                                </button>
                                <button
                                    onClick={() => setActiveTab('area')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'area' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Land & Area
                                </button>
                                <button
                                    onClick={() => setActiveTab('costs')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'costs' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Development Costs
                                </button>
                                <button
                                    onClick={() => setActiveTab('financing')}
                                    className={`px-4 py-2 rounded font-medium transition ${
                                        activeTab === 'financing' ? 'bg-purple-600 text-white' : 'hover:bg-gray-100'
                                    }`}
                                >
                                    Financing
                                </button>
                            </div>

                            <div>
                                {/* Timeline Tab */}
                                {activeTab === 'timeline' && (
                                    <div className="module-card p-6">
                                        <h3 className="text-2xl font-bold mb-6 text-gray-800">Project Details & Timeline</h3>
                                        
                                        <div className="grid grid-cols-2 gap-6 mb-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                                <input
                                                    type="text"
                                                    value={projectName}
                                                    onChange={(e) => setProjectName(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                                                <select
                                                    value={projectType}
                                                    onChange={(e) => setProjectType(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                >
                                                    <option value="residential">Residential</option>
                                                    <option value="hospitality">Hospitality</option>
                                                    <option value="mixed-use">Mixed-Use</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                                <input
                                                    type="text"
                                                    value={country}
                                                    onChange={(e) => setCountry(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                    placeholder="e.g., United States, UAE, UK"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                                                <select
                                                    value={currency}
                                                    onChange={(e) => setCurrency(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                >
                                                    <option value="USD">USD - US Dollar</option>
                                                    <option value="AED">AED - UAE Dirham</option>
                                                    <option value="EUR">EUR - Euro</option>
                                                    <option value="GBP">GBP - British Pound</option>
                                                    <option value="SAR">SAR - Saudi Riyal</option>
                                                    <option value="PKR">PKR - Pakistani Rupee</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Model Type</label>
                                                <select
                                                    value={modelType}
                                                    onChange={(e) => handleModelTypeChange(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                >
                                                    <option value="monthly">Monthly</option>
                                                    <option value="annual">Annual</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Project Start Date</label>
                                                <input
                                                    type="date"
                                                    value={projectStart}
                                                    onChange={(e) => setProjectStart(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Construction Periods ({modelType === 'monthly' ? 'Months' : 'Years'})
                                                </label>
                                                <input
                                                    type="number"
                                                    value={constructionPeriods}
                                                    onChange={(e) => setConstructionPeriods(parseInt(e.target.value) || 0)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Operations Periods ({modelType === 'monthly' ? 'Months' : 'Years'})
                                                </label>
                                                <input
                                                    type="number"
                                                    value={operationsPeriods}
                                                    onChange={(e) => setOperationsPeriods(parseInt(e.target.value) || 0)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                        </div>

                                        {/* Results Display */}
                                        <div className="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg border border-purple-200">
                                            <h4 className="font-bold text-gray-800 mb-4">Project Timeline Summary</h4>
                                            <div className="grid grid-cols-3 gap-6">
                                                <div>
                                                    <div className="text-sm text-gray-600 mb-1">Total Project Duration</div>
                                                    <div className="text-2xl font-bold text-purple-700">
                                                        {constructionPeriods + operationsPeriods} {modelType === 'monthly' ? 'Months' : 'Years'}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Construction: {constructionPeriods} | Operations: {operationsPeriods}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-gray-600 mb-1">Project End Date</div>
                                                    <div className="text-2xl font-bold text-blue-700">
                                                        {new Date(projectEndDate).toLocaleDateString('en-US', { 
                                                            month: 'short', 
                                                            day: 'numeric', 
                                                            year: 'numeric' 
                                                        })}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        From: {new Date(projectStart).toLocaleDateString('en-US', { 
                                                            month: 'short', 
                                                            year: 'numeric' 
                                                        })}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-gray-600 mb-1">Total Project Period</div>
                                                    <div className="text-2xl font-bold text-green-700">
                                                        {totalProjectYears} Years
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Model: {modelType === 'monthly' ? 'Monthly' : 'Annual'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Area Tab - With detailed calculations and validation */}
                                {activeTab === 'area' && (
                                    <div className="module-card p-6">
                                        <h3 className="text-2xl font-bold mb-6 text-gray-800">Land & Area Allocation</h3>
                                        
                                        {/* Land Acquisition Section */}
                                        <div className="mb-8">
                                            <h4 className="text-lg font-bold text-gray-700 mb-4">Land Acquisition</h4>
                                            <div className="grid grid-cols-4 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Total Land Area (sqm)</label>
                                                    <input
                                                        type="number"
                                                        value={totalLandArea}
                                                        onChange={(e) => setTotalLandArea(parseFloat(e.target.value) || 0)}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Land Value (per sqm)</label>
                                                    <input
                                                        type="number"
                                                        value={landValuePerSqm}
                                                        onChange={(e) => setLandValuePerSqm(parseFloat(e.target.value) || 0)}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Cash %</label>
                                                    <input
                                                        type="number"
                                                        value={cashPercent}
                                                        onChange={(e) => {
                                                            const val = parseFloat(e.target.value) || 0;
                                                            setCashPercent(val);
                                                            setInKindPercent(100 - val);
                                                        }}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        min="0"
                                                        max="100"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">In-Kind %</label>
                                                    <input
                                                        type="number"
                                                        value={inKindPercent}
                                                        onChange={(e) => {
                                                            const val = parseFloat(e.target.value) || 0;
                                                            setInKindPercent(val);
                                                            setCashPercent(100 - val);
                                                        }}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        min="0"
                                                        max="100"
                                                    />
                                                </div>
                                            </div>
                                            
                                            {/* Land Value Summary Table */}
                                            <div className="mt-4">
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="bg-gray-700 text-white">
                                                            <th className="p-2 text-left">Description</th>
                                                            <th className="p-2 text-right">Value ({currency})</th>
                                                            <th className="p-2 text-left">Calculation</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr className="bg-white">
                                                            <td className="p-2 border">Total Land Value</td>
                                                            <td className="p-2 border text-right font-bold">{formatNumber(totalLandValue)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {currency} {formatNumber(landValuePerSqm)}/sqm</td>
                                                        </tr>
                                                        <tr className="bg-green-50">
                                                            <td className="p-2 border">Cash Purchase</td>
                                                            <td className="p-2 border text-right font-bold text-green-700">{formatNumber(cashValue)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandValue)} × {cashPercent}%</td>
                                                        </tr>
                                                        <tr className="bg-blue-50">
                                                            <td className="p-2 border">In-Kind Contribution</td>
                                                            <td className="p-2 border text-right font-bold text-gray-800">{formatNumber(inKindValue)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandValue)} × {inKindPercent}%</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        {/* Area Allocation by Asset */}
                                        <div className="mb-6">
                                            <h4 className="text-lg font-bold text-gray-700 mb-4">Area Allocation by Asset</h4>
                                            
                                            <div className="grid grid-cols-3 gap-4 mb-4">
                                                {showResidential && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Residential %</label>
                                                        <input
                                                            type="number"
                                                            value={residentialPercent}
                                                            onChange={(e) => setResidentialPercent(parseFloat(e.target.value) || 0)}
                                                            className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        />
                                                    </div>
                                                )}
                                                {showHospitality && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Hospitality %</label>
                                                        <input
                                                            type="number"
                                                            value={hospitalityPercent}
                                                            onChange={(e) => setHospitalityPercent(parseFloat(e.target.value) || 0)}
                                                            className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                        />
                                                    </div>
                                                )}
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Retail %</label>
                                                    <input
                                                        type="number"
                                                        value={retailPercent}
                                                        onChange={(e) => setRetailPercent(parseFloat(e.target.value) || 0)}
                                                        className="input-assumption w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                            </div>

                                            {/* Validation Warning */}
                                            <div className={`p-3 rounded-lg mb-4 ${areaAllocationValid ? 'bg-green-50 border border-green-300' : 'bg-red-50 border border-red-300'}`}>
                                                <div className="flex items-center justify-between">
                                                    <span className={`font-medium ${areaAllocationValid ? 'text-green-700' : 'text-red-700'}`}>
                                                        Total Allocation: {totalAreaPercent.toFixed(1)}%
                                                    </span>
                                                    {areaAllocationValid ? (
                                                        <span className="text-green-700 font-bold">✓ Valid (100%)</span>
                                                    ) : (
                                                        <span className="text-red-700 font-bold">
                                                            ⚠ Error: Must equal 100% (Currently {totalAreaPercent > 100 ? 'over' : 'under'} by {Math.abs(100 - totalAreaPercent).toFixed(1)}%)
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Residential Breakdown */}
                                        {showResidential && (
                                            <div className="mb-6">
                                                <h4 className="text-lg font-bold text-gray-700 mb-3">Residential - Area Breakdown</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Metric</th>
                                                                <th className="p-2 text-center">Input</th>
                                                                <th className="p-2 text-center">Base Area</th>
                                                                <th className="p-2 text-right">Value (sqm)</th>
                                                                <th className="p-2 text-left">Calculation</th>
                                                                <th className="p-2 text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-blue-50">
                                                                <td className="p-2 border font-medium">Total Allocated Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialTotalArea)}</td>
                                                                <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {residentialPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Roads/Open Area</td>
                                                                <td className="p-2 border text-center">
                                                                    <input
                                                                        type="number"
                                                                        value={residentialRoadsPercent}
                                                                        onChange={(e) => setResidentialRoadsPercent(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right text-gray-900">{formatNumber(residentialRoadsArea)}</td>
                                                                <td className="p-2 border">{formatNumber(residentialTotalArea)} sqm × {residentialRoadsPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-green-100">
                                                                <td className="p-2 border font-bold">Net Developable Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialNetArea)}</td>
                                                                <td className="p-2 border">{formatNumber(residentialTotalArea)} - {formatNumber(residentialRoadsArea)}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">GFA (Gross Floor Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    FAR: <input
                                                                        type="number"
                                                                        value={residentialFAR}
                                                                        onChange={(e) => setResidentialFAR(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        step="0.1"
                                                                        min="0"
                                                                    />
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={residentialGFABase}
                                                                        onChange={(e) => setResidentialGFABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialGFA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(residentialGFABase)} × {residentialFAR}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-blue-100">
                                                                <td className="p-2 border font-bold">BUA (Built-Up Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    Eff: <input
                                                                        type="number"
                                                                        value={(residentialEfficiency * 100).toFixed(0)}
                                                                        onChange={(e) => setResidentialEfficiency(parseFloat(e.target.value) / 100 || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={residentialBUABase}
                                                                        onChange={(e) => setResidentialBUABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="gfa">GFA</option>
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(residentialBUA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(residentialBUABase)} × {(residentialEfficiency * 100).toFixed(0)}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            
                                                            {/* Custom Rows */}
                                                            {residentialCustomRows.map((customRow) => {
                                                                const baseValue = getBaseAreaValue(customRow.baseArea, residentialTotalArea, residentialNetArea, residentialGFA);
                                                                const calculatedValue = baseValue * customRow.multiplier;
                                                                
                                                                return (
                                                                    <tr key={customRow.id} className="bg-yellow-50">
                                                                        <td className="p-2 border">
                                                                            <input
                                                                                type="text"
                                                                                value={customRow.name}
                                                                                onChange={(e) => updateCustomRow('residential', customRow.id, 'name', e.target.value)}
                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <input
                                                                                type="number"
                                                                                value={customRow.multiplier}
                                                                                onChange={(e) => updateCustomRow('residential', customRow.id, 'multiplier', parseFloat(e.target.value) || 0)}
                                                                                className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                                step="0.1"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <select 
                                                                                value={customRow.baseArea}
                                                                                onChange={(e) => updateCustomRow('residential', customRow.id, 'baseArea', e.target.value)}
                                                                                className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                            >
                                                                                <option value="totalAllocated">Total Allocated Area</option>
                                                                                <option value="netDevelopable">Net Developable Area</option>
                                                                                <option value="gfa">GFA</option>
                                                                            </select>
                                                                        </td>
                                                                        <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(calculatedValue)}</td>
                                                                        <td className="p-2 border">{getBaseAreaName(customRow.baseArea)} × {customRow.multiplier}</td>
                                                                        <td className="p-2 border text-center">
                                                                            <button 
                                                                                onClick={() => deleteCustomRow('residential', customRow.id)}
                                                                                className="text-red-600 hover:text-red-800 text-sm font-bold"
                                                                            >
                                                                                🗑️
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    <div className="mt-3">
                                                        <button 
                                                            onClick={() => addCustomRow('residential')}
                                                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                                        >
                                                            + Add Row
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Hospitality Breakdown */}
                                        {showHospitality && (
                                            <div className="mb-6">
                                                <h4 className="text-lg font-bold text-gray-700 mb-3">Hospitality - Area Breakdown</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="bg-gray-700 text-white">
                                                                <th className="p-2 text-left">Metric</th>
                                                                <th className="p-2 text-center">Input</th>
                                                                <th className="p-2 text-center">Base Area</th>
                                                                <th className="p-2 text-right">Value (sqm)</th>
                                                                <th className="p-2 text-left">Calculation</th>
                                                                <th className="p-2 text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr className="bg-green-50">
                                                                <td className="p-2 border font-medium">Total Allocated Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityTotalArea)}</td>
                                                                <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {hospitalityPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">Roads/Open Area</td>
                                                                <td className="p-2 border text-center">
                                                                    <input
                                                                        type="number"
                                                                        value={hospitalityRoadsPercent}
                                                                        onChange={(e) => setHospitalityRoadsPercent(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right text-gray-900">{formatNumber(hospitalityRoadsArea)}</td>
                                                                <td className="p-2 border">{formatNumber(hospitalityTotalArea)} sqm × {hospitalityRoadsPercent}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-green-100">
                                                                <td className="p-2 border font-bold">Net Developable Area</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-center">-</td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityNetArea)}</td>
                                                                <td className="p-2 border">{formatNumber(hospitalityTotalArea)} - {formatNumber(hospitalityRoadsArea)}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-white">
                                                                <td className="p-2 border">GFA (Gross Floor Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    FAR: <input
                                                                        type="number"
                                                                        value={hospitalityFAR}
                                                                        onChange={(e) => setHospitalityFAR(parseFloat(e.target.value) || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        step="0.1"
                                                                        min="0"
                                                                    />
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={hospitalityGFABase}
                                                                        onChange={(e) => setHospitalityGFABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityGFA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(hospitalityGFABase)} × {hospitalityFAR}</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            <tr className="bg-green-100">
                                                                <td className="p-2 border font-bold">BUA (Built-Up Area)</td>
                                                                <td className="p-2 border text-center">
                                                                    Eff: <input
                                                                        type="number"
                                                                        value={(hospitalityEfficiency * 100).toFixed(0)}
                                                                        onChange={(e) => setHospitalityEfficiency(parseFloat(e.target.value) / 100 || 0)}
                                                                        className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                        min="0"
                                                                        max="100"
                                                                    /> %
                                                                </td>
                                                                <td className="p-2 border text-center">
                                                                    <select 
                                                                        value={hospitalityBUABase}
                                                                        onChange={(e) => setHospitalityBUABase(e.target.value)}
                                                                        className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                    >
                                                                        <option value="gfa">GFA</option>
                                                                        <option value="netDevelopable">Net Developable Area</option>
                                                                        <option value="totalAllocated">Total Allocated Area</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(hospitalityBUA)}</td>
                                                                <td className="p-2 border">{getBaseAreaName(hospitalityBUABase)} × {(hospitalityEfficiency * 100).toFixed(0)}%</td>
                                                                <td className="p-2 border text-center">-</td>
                                                            </tr>
                                                            
                                                            {/* Custom Rows */}
                                                            {hospitalityCustomRows.map((customRow) => {
                                                                const baseValue = getBaseAreaValue(customRow.baseArea, hospitalityTotalArea, hospitalityNetArea, hospitalityGFA);
                                                                const calculatedValue = baseValue * customRow.multiplier;
                                                                
                                                                return (
                                                                    <tr key={customRow.id} className="bg-yellow-50">
                                                                        <td className="p-2 border">
                                                                            <input
                                                                                type="text"
                                                                                value={customRow.name}
                                                                                onChange={(e) => updateCustomRow('hospitality', customRow.id, 'name', e.target.value)}
                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <input
                                                                                type="number"
                                                                                value={customRow.multiplier}
                                                                                onChange={(e) => updateCustomRow('hospitality', customRow.id, 'multiplier', parseFloat(e.target.value) || 0)}
                                                                                className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                                step="0.1"
                                                                            />
                                                                        </td>
                                                                        <td className="p-2 border text-center">
                                                                            <select 
                                                                                value={customRow.baseArea}
                                                                                onChange={(e) => updateCustomRow('hospitality', customRow.id, 'baseArea', e.target.value)}
                                                                                className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                            >
                                                                                <option value="totalAllocated">Total Allocated Area</option>
                                                                                <option value="netDevelopable">Net Developable Area</option>
                                                                                <option value="gfa">GFA</option>
                                                                            </select>
                                                                        </td>
                                                                        <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(calculatedValue)}</td>
                                                                        <td className="p-2 border">{getBaseAreaName(customRow.baseArea)} × {customRow.multiplier}</td>
                                                                        <td className="p-2 border text-center">
                                                                            <button 
                                                                                onClick={() => deleteCustomRow('hospitality', customRow.id)}
                                                                                className="text-red-600 hover:text-red-800 text-sm font-bold"
                                                                            >
                                                                                🗑️
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    <div className="mt-3">
                                                        <button 
                                                            onClick={() => addCustomRow('hospitality')}
                                                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                                        >
                                                            + Add Row
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Retail Breakdown */}
                                        <div className="mb-6">
                                            <h4 className="text-lg font-bold text-gray-700 mb-3">Retail - Area Breakdown</h4>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="bg-gray-700 text-white">
                                                            <th className="p-2 text-left">Metric</th>
                                                            <th className="p-2 text-center">Input</th>
                                                            <th className="p-2 text-center">Base Area</th>
                                                            <th className="p-2 text-right">Value (sqm)</th>
                                                            <th className="p-2 text-left">Calculation</th>
                                                            <th className="p-2 text-center">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr className="bg-purple-50">
                                                            <td className="p-2 border font-medium">Total Allocated Area</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailTotalArea)}</td>
                                                            <td className="p-2 border">{formatNumber(totalLandArea)} sqm × {retailPercent}%</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-white">
                                                            <td className="p-2 border">Roads/Open Area</td>
                                                            <td className="p-2 border text-center">
                                                                <input
                                                                    type="number"
                                                                    value={retailRoadsPercent}
                                                                    onChange={(e) => setRetailRoadsPercent(parseFloat(e.target.value) || 0)}
                                                                    className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                    min="0"
                                                                    max="100"
                                                                /> %
                                                            </td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-right text-gray-900">{formatNumber(retailRoadsArea)}</td>
                                                            <td className="p-2 border">{formatNumber(retailTotalArea)} sqm × {retailRoadsPercent}%</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-purple-100">
                                                            <td className="p-2 border font-bold">Net Developable Area</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-center">-</td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailNetArea)}</td>
                                                            <td className="p-2 border">{formatNumber(retailTotalArea)} - {formatNumber(retailRoadsArea)}</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-white">
                                                            <td className="p-2 border">GFA (Gross Floor Area)</td>
                                                            <td className="p-2 border text-center">
                                                                FAR: <input
                                                                    type="number"
                                                                    value={retailFAR}
                                                                    onChange={(e) => setRetailFAR(parseFloat(e.target.value) || 0)}
                                                                    className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                    step="0.1"
                                                                    min="0"
                                                                />
                                                            </td>
                                                            <td className="p-2 border text-center">
                                                                <select 
                                                                    value={retailGFABase}
                                                                    onChange={(e) => setRetailGFABase(e.target.value)}
                                                                    className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                >
                                                                    <option value="netDevelopable">Net Developable Area</option>
                                                                    <option value="totalAllocated">Total Allocated Area</option>
                                                                </select>
                                                            </td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailGFA)}</td>
                                                            <td className="p-2 border">{getBaseAreaName(retailGFABase)} × {retailFAR}</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        <tr className="bg-purple-100">
                                                            <td className="p-2 border font-bold">BUA (Built-Up Area)</td>
                                                            <td className="p-2 border text-center">
                                                                Eff: <input
                                                                    type="number"
                                                                    value={(retailEfficiency * 100).toFixed(0)}
                                                                    onChange={(e) => setRetailEfficiency(parseFloat(e.target.value) / 100 || 0)}
                                                                    className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                    min="0"
                                                                    max="100"
                                                                /> %
                                                            </td>
                                                            <td className="p-2 border text-center">
                                                                <select 
                                                                    value={retailBUABase}
                                                                    onChange={(e) => setRetailBUABase(e.target.value)}
                                                                    className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                >
                                                                    <option value="gfa">GFA</option>
                                                                    <option value="netDevelopable">Net Developable Area</option>
                                                                    <option value="totalAllocated">Total Allocated Area</option>
                                                                </select>
                                                            </td>
                                                            <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(retailBUA)}</td>
                                                            <td className="p-2 border">{getBaseAreaName(retailBUABase)} × {(retailEfficiency * 100).toFixed(0)}%</td>
                                                            <td className="p-2 border text-center">-</td>
                                                        </tr>
                                                        
                                                        {/* Custom Rows */}
                                                        {retailCustomRows.map((customRow) => {
                                                            const baseValue = getBaseAreaValue(customRow.baseArea, retailTotalArea, retailNetArea, retailGFA);
                                                            const calculatedValue = baseValue * customRow.multiplier;
                                                            
                                                            return (
                                                                <tr key={customRow.id} className="bg-yellow-50">
                                                                    <td className="p-2 border">
                                                                        <input
                                                                            type="text"
                                                                            value={customRow.name}
                                                                            onChange={(e) => updateCustomRow('retail', customRow.id, 'name', e.target.value)}
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                        />
                                                                    </td>
                                                                    <td className="p-2 border text-center">
                                                                        <input
                                                                            type="number"
                                                                            value={customRow.multiplier}
                                                                            onChange={(e) => updateCustomRow('retail', customRow.id, 'multiplier', parseFloat(e.target.value) || 0)}
                                                                            className="input-assumption w-16 px-2 py-1 border rounded text-center"
                                                                            step="0.1"
                                                                        />
                                                                    </td>
                                                                    <td className="p-2 border text-center">
                                                                        <select 
                                                                            value={customRow.baseArea}
                                                                            onChange={(e) => updateCustomRow('retail', customRow.id, 'baseArea', e.target.value)}
                                                                            className="px-2 py-1 border border-gray-300 rounded text-xs w-full"
                                                                        >
                                                                            <option value="totalAllocated">Total Allocated Area</option>
                                                                            <option value="netDevelopable">Net Developable Area</option>
                                                                            <option value="gfa">GFA</option>
                                                                        </select>
                                                                    </td>
                                                                    <td className="p-2 border text-right font-bold text-gray-900">{formatNumber(calculatedValue)}</td>
                                                                    <td className="p-2 border">{getBaseAreaName(customRow.baseArea)} × {customRow.multiplier}</td>
                                                                    <td className="p-2 border text-center">
                                                                        <button 
                                                                            onClick={() => deleteCustomRow('retail', customRow.id)}
                                                                            className="text-red-600 hover:text-red-800 text-sm font-bold"
                                                                        >
                                                                            🗑️
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                                <div className="mt-3">
                                                    <button 
                                                        onClick={() => addCustomRow('retail')}
                                                        className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                                    >
                                                        + Add Row
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Development Costs Tab */}
                                {activeTab === 'costs' && (
                                    <DevCostsTab
                                        showResidential={showResidential}
                                        showHospitality={showHospitality}
                                        showRetail={showRetail}
                                        constructionPeriods={constructionPeriods}
                                        modelType={modelType}
                                        totalLandArea={totalLandArea}
                                        cashPercent={cashPercent}
                                        landValuePerSqm={landValuePerSqm}
                                        residentialPercent={residentialPercent}
                                        hospitalityPercent={hospitalityPercent}
                                        retailPercent={retailPercent}
                                        residentialTotalArea={residentialTotalArea}
                                        residentialNetArea={residentialNetArea}
                                        residentialGFA={residentialGFA}
                                        residentialBUA={residentialBUA}
                                        hospitalityTotalArea={hospitalityTotalArea}
                                        hospitalityNetArea={hospitalityNetArea}
                                        hospitalityGFA={hospitalityGFA}
                                        hospitalityBUA={hospitalityBUA}
                                        retailTotalArea={retailTotalArea}
                                        retailNetArea={retailNetArea}
                                        retailGFA={retailGFA}
                                        retailBUA={retailBUA}
                                        formatNumber={formatNumber}
                                    />
                                )}

                                {/* Financing Tab */}
                                {activeTab === 'financing' && (
                                    <div className="module-card p-6">
                                        <div className="flex flex-col items-center justify-center py-24 text-center">
                                            <div className="text-6xl mb-6">🚧</div>
                                            <h3 className="text-3xl font-bold text-gray-700 mb-3">Financing</h3>
                                            <p className="text-gray-500 text-lg">Coming Soon</p>
                                            <p className="text-gray-400 text-sm mt-2">This module is currently under development</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ═══════════════════════════════════════════════════════════════
        // DEVELOPMENT COSTS COMPONENT
        // ═══════════════════════════════════════════════════════════════
        function DevCostsTab(props) {
            const {
                showResidential, showHospitality, showRetail,
                constructionPeriods, modelType,
                totalLandArea, cashPercent, landValuePerSqm,
                residentialPercent, hospitalityPercent, retailPercent,
                residentialTotalArea, residentialNetArea, residentialGFA, residentialBUA,
                hospitalityTotalArea, hospitalityNetArea, hospitalityGFA, hospitalityBUA,
                retailTotalArea, retailNetArea, retailGFA, retailBUA,
                formatNumber
            } = props;

            const cashLandValue  = totalLandArea * landValuePerSqm * (cashPercent / 100);
            const resLandCost    = cashLandValue * (residentialPercent  / 100);
            const hospLandCost   = cashLandValue * (hospitalityPercent  / 100);
            const retLandCost    = cashLandValue * (retailPercent       / 100);

            const makeDefaults = (landCost, buaRate) => [
                { id:1,  name:'Land (Cash Portion)',            method:'fixed',           value:landCost, baseType:'',                       selectedCosts:[],      startPeriod:0, endPeriod:0,                  phasing:'100',             canDelete:false },
                { id:2,  name:'Construction Cost',              method:'rate_bua',         value:buaRate,  baseType:'',                       selectedCosts:[],      startPeriod:7, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                { id:3,  name:'Infrastructure Cost',            method:'rate_total_area',  value:150,      baseType:'',                       selectedCosts:[],      startPeriod:1, endPeriod:6,                  phasing:'30,25,20,15,7,3', canDelete:true  },
                { id:4,  name:'Landscaping Cost',               method:'rate_total_area',  value:50,       baseType:'',                       selectedCosts:[],      startPeriod:1, endPeriod:6,                  phasing:'30,25,20,15,7,3', canDelete:true  },
                { id:5,  name:'Pre-Operating Expenses',         method:'percent_base',     value:2,        baseType:'construction_infra_land', selectedCosts:[],      startPeriod:1, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                { id:6,  name:'Professional Fee',               method:'percent_base',     value:5,        baseType:'excl_land',               selectedCosts:[],      startPeriod:1, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                { id:7,  name:'Contingency Cost',               method:'percent_base',     value:3,        baseType:'excl_land',               selectedCosts:[],      startPeriod:1, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                { id:8,  name:'Developer Fee/Performance Fee',  method:'percent_base',     value:10,       baseType:'custom_selection',        selectedCosts:[2,3,4], startPeriod:1, endPeriod:constructionPeriods, phasing:'even',            canDelete:true  },
                { id:9,  name:'Electricity Station',            method:'fixed',            value:500000,   baseType:'',                       selectedCosts:[],      startPeriod:3, endPeriod:8,                  phasing:'even',            canDelete:true  },
                { id:10, name:'Bridges',                        method:'fixed',            value:750000,   baseType:'',                       selectedCosts:[],      startPeriod:2, endPeriod:6,                  phasing:'even',            canDelete:true  },
                { id:11, name:'Royal Commission Premium',        method:'percent_base',     value:2.5,      baseType:'land_cost',               selectedCosts:[],      startPeriod:0, endPeriod:0,                  phasing:'100',             canDelete:true  },
                { id:12, name:'RETT (Real Estate Transfer Tax)', method:'percent_base',    value:5,        baseType:'cash_land_value',         selectedCosts:[],      startPeriod:0, endPeriod:0,                  phasing:'100',             canDelete:true  },
            ];

            const { useState, useEffect } = React;

            const [resCosts,  setResCosts]  = useState(() => makeDefaults(resLandCost,  1200));
            const [hospCosts, setHospCosts] = useState(() => makeDefaults(hospLandCost, 1500));
            const [retCosts,  setRetCosts]  = useState(() => makeDefaults(retLandCost,  1000));
            const [nextId, setNextId] = useState(13);

            useEffect(() => {
                setResCosts(prev  => prev.map(c => c.id===1 ? {...c, value:resLandCost}  : c));
            }, [resLandCost]);
            useEffect(() => {
                setHospCosts(prev => prev.map(c => c.id===1 ? {...c, value:hospLandCost} : c));
            }, [hospLandCost]);
            useEffect(() => {
                setRetCosts(prev  => prev.map(c => c.id===1 ? {...c, value:retLandCost}  : c));
            }, [retLandCost]);

            const getAreas = (asset) => {
                if (asset==='res')  return { total:residentialTotalArea, net:residentialNetArea, gfa:residentialGFA, bua:residentialBUA };
                if (asset==='hosp') return { total:hospitalityTotalArea, net:hospitalityNetArea, gfa:hospitalityGFA, bua:hospitalityBUA };
                return                      { total:retailTotalArea,     net:retailNetArea,      gfa:retailGFA,      bua:retailBUA      };
            };

            const landCostForAsset = (asset) => asset==='res' ? resLandCost : asset==='hosp' ? hospLandCost : retLandCost;

            const calcTotal = (cost, costs, asset) => {
                const a = getAreas(asset);
                if (cost.method==='fixed')          return parseFloat(cost.value)||0;
                if (cost.method==='rate_total_area') return (parseFloat(cost.value)||0)*a.total;
                if (cost.method==='rate_net_area')   return (parseFloat(cost.value)||0)*a.net;
                if (cost.method==='rate_gfa')        return (parseFloat(cost.value)||0)*a.gfa;
                if (cost.method==='rate_bua')        return (parseFloat(cost.value)||0)*a.bua;
                if (cost.method==='percent_base') {
                    const pct = (parseFloat(cost.value)||0)/100;
                    let base = 0;
                    if (cost.baseType==='construction_infra_land') {
                        [2,3,4].forEach(id => { const c=costs.find(x=>x.id===id); if(c) base+=calcTotal(c,costs,asset); });
                    } else if (cost.baseType==='excl_land') {
                        costs.forEach(c => { if(c.id!==cost.id && c.id!==1) base+=calcTotal(c,costs,asset); });
                    } else if (cost.baseType==='land_cost') {
                        base = landCostForAsset(asset);
                    } else if (cost.baseType==='cash_land_value') {
                        base = landCostForAsset(asset);
                    } else if (cost.baseType==='custom_selection') {
                        (cost.selectedCosts||[]).forEach(id => { const c=costs.find(x=>x.id===id); if(c&&c.id!==cost.id) base+=calcTotal(c,costs,asset); });
                    } else if (cost.baseType==='all_previous') {
                        const idx=costs.findIndex(c=>c.id===cost.id);
                        if(idx>0) costs.slice(0,idx).forEach(c=>{ base+=calcTotal(c,costs,asset); });
                    }
                    return base*pct;
                }
                return 0;
            };

            const validatePhasing = (phasing, start, end) => {
                if (phasing.trim().toLowerCase()==='even') return {valid:true,error:''};
                const periods = end-start+1;
                const vals = phasing.split(',').map(v=>parseFloat(v.trim())).filter(v=>!isNaN(v));
                if (vals.length!==periods) return {valid:false,error:`Need ${periods} values`};
                const sum = vals.reduce((a,b)=>a+b,0);
                if (Math.abs(sum-100)>0.01) return {valid:false,error:`Sum=${sum.toFixed(1)}% (need 100%)`};
                return {valid:true,error:''};
            };

            const distribute = (cost, costs, asset) => {
                const total = calcTotal(cost, costs, asset);
                const dist  = Array(constructionPeriods+1).fill(0);
                if (cost.phasing.trim().toLowerCase()==='even') {
                    const n = cost.endPeriod - cost.startPeriod + 1;
                    for (let i=cost.startPeriod; i<=cost.endPeriod && i<=constructionPeriods; i++) dist[i]=total/n;
                } else {
                    const pcts = cost.phasing.split(',').map(v=>parseFloat(v.trim())).filter(v=>!isNaN(v));
                    pcts.forEach((p,i)=>{ const per=cost.startPeriod+i; if(per<=constructionPeriods) dist[per]=total*(p/100); });
                }
                return dist;
            };

            const buildCapex = (costs, asset) => {
                const items  = costs.map(c=>({name:c.name, total:calcTotal(c,costs,asset), distribution:distribute(c,costs,asset)}));
                const totals = Array(constructionPeriods+1).fill(0);
                items.forEach(item=>item.distribution.forEach((v,i)=>totals[i]+=v));
                return {items, totals};
            };

            const addCost = (setCosts) => {
                const newId = nextId;
                setNextId(n=>n+1);
                setCosts(prev=>[...prev,{id:newId,name:'New Cost Item',method:'fixed',value:0,baseType:'',selectedCosts:[],startPeriod:1,endPeriod:constructionPeriods,phasing:'even',canDelete:true}]);
            };
            const delCost = (id, setCosts) => setCosts(prev=>prev.filter(c=>c.id!==id));
            const updCost = (id, field, value, setCosts) => setCosts(prev=>prev.map(c=>c.id===id?{...c,[field]:value}:c));

            const lbl = (i) => modelType==='monthly' ? `M${i}` : `Y${i}`;

            const CostSection = ({title, color, costs, setCosts, asset, capex}) => (
                <div className="module-card p-6 mb-6">
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                        <h2 style={{fontSize:'1.2rem',fontWeight:'700'}} className={color}>{title}</h2>
                        <button onClick={()=>addCost(setCosts)} className="btn-primary" style={{color:'white',padding:'6px 14px',borderRadius:'8px',fontWeight:'600',fontSize:'0.85rem',cursor:'pointer',border:'none'}}>+ Add Cost Item</button>
                    </div>

                    <div style={{overflowX:'auto',marginBottom:'24px'}}>
                        <table style={{fontSize:'0.8rem',borderCollapse:'collapse',width:'100%',minWidth:'900px'}}>
                            <thead>
                                <tr style={{background:'#1f2937',color:'white'}}>
                                    <th style={{padding:'8px',textAlign:'left',minWidth:'160px'}}>Cost Item</th>
                                    <th style={{padding:'8px',textAlign:'left',minWidth:'160px'}}>Method</th>
                                    <th style={{padding:'8px',textAlign:'left',minWidth:'100px'}}>Value</th>
                                    <th style={{padding:'8px',textAlign:'left',minWidth:'180px'}}>Base Cost Type</th>
                                    <th style={{padding:'8px',textAlign:'center',minWidth:'55px'}}>Start</th>
                                    <th style={{padding:'8px',textAlign:'center',minWidth:'55px'}}>End</th>
                                    <th style={{padding:'8px',textAlign:'left',minWidth:'150px'}}>Phasing</th>
                                    <th style={{padding:'8px',textAlign:'right',minWidth:'110px'}}>Total Cost</th>
                                    <th style={{padding:'8px',minWidth:'40px'}}></th>
                                </tr>
                            </thead>
                            <tbody>
                                {costs.map((cost,idx)=>{
                                    const v = validatePhasing(cost.phasing, cost.startPeriod, cost.endPeriod);
                                    const rowBg = idx%2===0?'white':'#f9fafb';
                                    const inp = {width:'100%',padding:'4px',border:'1px solid #d1d5db',borderRadius:'4px',fontSize:'0.8rem'};
                                    return (
                                        <tr key={cost.id} style={{background:rowBg}}>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb'}}>
                                                <input type="text" value={cost.name} disabled={!cost.canDelete}
                                                    style={{...inp,background:cost.canDelete?'#fef3c7':'#f3f4f6'}}
                                                    onChange={e=>updCost(cost.id,'name',e.target.value,setCosts)} />
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb'}}>
                                                <select value={cost.method} disabled={!cost.canDelete} style={inp}
                                                    onChange={e=>updCost(cost.id,'method',e.target.value,setCosts)}>
                                                    <option value="fixed">Fixed Amount</option>
                                                    <option value="rate_total_area">Rate/SQM - Total Area</option>
                                                    <option value="rate_net_area">Rate/SQM - Net Area</option>
                                                    <option value="rate_gfa">Rate/SQM - GFA</option>
                                                    <option value="rate_bua">Rate/SQM - BUA</option>
                                                    <option value="percent_base">% of Base Costs</option>
                                                </select>
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb'}}>
                                                <div style={{display:'flex',alignItems:'center',gap:'2px'}}>
                                                    <span style={{color:'#6b7280',fontSize:'0.75rem'}}>{cost.method==='percent_base'?'%':'$'}</span>
                                                    <input type="number" value={cost.value} disabled={cost.id===1}
                                                        style={{...inp,background:'#fef3c7',fontWeight:'600'}}
                                                        onChange={e=>updCost(cost.id,'value',parseFloat(e.target.value)||0,setCosts)} />
                                                </div>
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb'}}>
                                                {cost.method==='percent_base' ? (
                                                    <div>
                                                        <select value={cost.baseType} style={{...inp,marginBottom:'3px'}}
                                                            onChange={e=>updCost(cost.id,'baseType',e.target.value,setCosts)}>
                                                            <option value="excl_land">Total Constr. (Excl. Land)</option>
                                                            <option value="construction_infra_land">Constr+Infra+Landscaping</option>
                                                            <option value="land_cost">Land Cost Only</option>
                                                            <option value="cash_land_value">Cash Land Value</option>
                                                            <option value="custom_selection">Custom Selection</option>
                                                            <option value="all_previous">All Previous Costs</option>
                                                        </select>
                                                        {cost.baseType==='custom_selection' && (
                                                            <div style={{maxHeight:'80px',overflowY:'auto',border:'1px solid #d1d5db',borderRadius:'4px',padding:'2px',fontSize:'0.7rem'}}>
                                                                {costs.filter(c=>c.id!==cost.id&&c.id!==1).map(c=>(
                                                                    <label key={c.id} style={{display:'block',padding:'1px 3px',cursor:'pointer'}}>
                                                                        <input type="checkbox"
                                                                            checked={(cost.selectedCosts||[]).includes(c.id)}
                                                                            style={{marginRight:'4px'}}
                                                                            onChange={e=>{
                                                                                const sel=cost.selectedCosts||[];
                                                                                updCost(cost.id,'selectedCosts',e.target.checked?[...sel,c.id]:sel.filter(x=>x!==c.id),setCosts);
                                                                            }} />
                                                                        {c.name}
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : <span style={{color:'#9ca3af',fontSize:'0.75rem'}}>N/A</span>}
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb',textAlign:'center'}}>
                                                <input type="number" value={cost.startPeriod} min="0" max={constructionPeriods} disabled={cost.id===1}
                                                    style={{...inp,width:'50px',textAlign:'center'}}
                                                    onChange={e=>updCost(cost.id,'startPeriod',parseInt(e.target.value)||0,setCosts)} />
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb',textAlign:'center'}}>
                                                <input type="number" value={cost.endPeriod} min="0" max={constructionPeriods} disabled={cost.id===1}
                                                    style={{...inp,width:'50px',textAlign:'center'}}
                                                    onChange={e=>updCost(cost.id,'endPeriod',parseInt(e.target.value)||0,setCosts)} />
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb'}}>
                                                <input type="text" value={cost.phasing} disabled={cost.id===1}
                                                    placeholder="30,25,20,15,7,3 or even"
                                                    style={{...inp,borderColor:v.valid?'#d1d5db':'#ef4444'}}
                                                    onChange={e=>updCost(cost.id,'phasing',e.target.value,setCosts)} />
                                                {!v.valid && <div style={{color:'#ef4444',fontSize:'0.65rem'}}>{v.error}</div>}
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb',textAlign:'right',fontWeight:'600'}}>
                                                ${formatNumber(calcTotal(cost,costs,asset))}
                                            </td>
                                            <td style={{padding:'5px',border:'1px solid #e5e7eb',textAlign:'center'}}>
                                                {cost.canDelete && <button onClick={()=>delCost(cost.id,setCosts)} style={{background:'none',border:'none',cursor:'pointer',color:'#ef4444',fontSize:'1rem'}}>🗑️</button>}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    <h3 style={{fontSize:'1rem',fontWeight:'700',marginBottom:'10px'}} className={color}>{title} — CAPEX SUMMARY</h3>
                    <div style={{overflowX:'auto'}}>
                        <table style={{fontSize:'0.78rem',borderCollapse:'collapse',width:'100%'}}>
                            <thead>
                                <tr style={{background:'#1f2937',color:'white'}}>
                                    <th style={{padding:'7px',textAlign:'left',minWidth:'160px',position:'sticky',left:0,background:'#1f2937'}}>Description</th>
                                    <th style={{padding:'7px',textAlign:'right',minWidth:'110px'}}>Total</th>
                                    {Array.from({length:constructionPeriods+1},(_,i)=>(
                                        <th key={i} style={{padding:'7px',textAlign:'right',minWidth:'65px',whiteSpace:'nowrap'}}>{lbl(i)}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {capex.items.map((item,idx)=>{
                                    const bg = idx%2===0?'white':'#f9fafb';
                                    return (
                                        <tr key={idx} style={{background:bg}}>
                                            <td style={{padding:'6px',border:'1px solid #e5e7eb',fontWeight:'500',position:'sticky',left:0,background:bg}}>{item.name}</td>
                                            <td style={{padding:'6px',border:'1px solid #e5e7eb',textAlign:'right',fontWeight:'600'}}>${formatNumber(item.total)}</td>
                                            {item.distribution.map((amt,pi)=>(
                                                <td key={pi} style={{padding:'6px',border:'1px solid #e5e7eb',textAlign:'right',color:amt>0?'#111827':'#d1d5db'}}>
                                                    {amt>0?`$${formatNumber(amt)}`:'-'}
                                                </td>
                                            ))}
                                        </tr>
                                    );
                                })}
                                <tr style={{background:'#dbeafe',fontWeight:'700'}}>
                                    <td style={{padding:'7px',border:'1px solid #93c5fd',position:'sticky',left:0,background:'#dbeafe'}}>TOTAL CAPEX</td>
                                    <td style={{padding:'7px',border:'1px solid #93c5fd',textAlign:'right'}}>${formatNumber(capex.totals.reduce((a,b)=>a+b,0))}</td>
                                    {capex.totals.map((t,pi)=>(
                                        <td key={pi} style={{padding:'7px',border:'1px solid #93c5fd',textAlign:'right'}}>{t>0?`$${formatNumber(t)}`:'-'}</td>
                                    ))}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const resCapex  = buildCapex(resCosts,  'res');
            const hospCapex = buildCapex(hospCosts, 'hosp');
            const retCapex  = buildCapex(retCosts,  'ret');

            return (
                <div>
                    {showResidential && <CostSection title="RESIDENTIAL DEVELOPMENT COSTS" color="text-blue-800"   costs={resCosts}  setCosts={setResCosts}  asset="res"  capex={resCapex}  />}
                    {showHospitality && <CostSection title="HOSPITALITY DEVELOPMENT COSTS"  color="text-green-800"  costs={hospCosts} setCosts={setHospCosts} asset="hosp" capex={hospCapex} />}
                    {showRetail      && <CostSection title="RETAIL DEVELOPMENT COSTS"       color="text-purple-800" costs={retCosts}  setCosts={setRetCosts}  asset="ret"  capex={retCapex}  />}
                </div>
            );
        }

        ReactDOM.render(<RealEstatePlatform />, document.getElementById('root'));
    </script>
</body>
</html>
